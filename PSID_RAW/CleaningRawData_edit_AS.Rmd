---
title: "Cleaning PSID Data"
output: 
  html_document:
    toc: true
    toc_depth: 2
---

```{r setup, include = FALSE}
knitr::opts_chunk$set(eval = TRUE)
```


# Preliminary Stuff

The main sampling unit for the PSID is the *household*, in which a "head" and potential "spouse" are identified along with other family unit members. Individuals in the survey are uniquely identified by the Interview Number of the original 1968 Family that they are linked to (*INTNUM68*) and their person number within that family dynasty (*PERNUM*). A unique individual number can be created as:
\[ ID = INTNUM68\times1000 + PERNUM \]

Since it is labor-intensive to track individuals over time and link them with their domestic partners and children, the PSID has created three useful files that we will make use of. The *Cross-Year Individual File* links individuals in each year to a family survey number for that year as well as their identified position within that household (this would allow us, for example, to link an individual who is the "wife" in their household to the earnings of the "wife" in that household interview file.). The *Childbirth and Adoption History File* tracks information about births for each individual (and conversely the parentage of all individuals), while the *Marriage History File* tracks marriages. While most of the data comes from the local directory, these files are taken from a different directory that I use for all my PSID-related projects.

When it comes time to assemble the main panel for our anlaysis, we will make use of all three of these files. In particular we will use a previously cleaned panel version of the the individual file that is not stored locally in the dropbox as it is slightly larger in size.

Finally, the libraries we will use for all of this work can be loaded here:

```{r}
library(dplyr)
library(tidyr)
```


# Time Use From Time Diaries

First load the 1997 and 2002 time diaries, clean them, and rename the files so they are consistent across those years. The coding manual for time use activities are [here](~/Dropbox/PSID_CDS/Docs/codingman.pdf) and [here.](~/Dropbox/PSID_CDS/Docs/2003codebook.pdf). Inspecting these you will see that the code categories are slightly more fine in the 2002 wave (one extra digit). So for example a category coded as 919 in 1997 becomes 9190 in 2002 or potentially 919$x$ for some $x\in\{1,...,9\}$ depending on the sub-category.

For a consistent sent of categories, we use the 1997 activity codes and round down to the nearest multiple of 10 for 2002 categories. Here is a summary of the variables:

Variable      Description
------------  -------------------------------------- 
COLA          Activity Code
DURATION      Duration of activity in seconds
COLG_B        Mother participating in activity
COLG_C        Father partcipating in activity
COLH_B        Mother around but not participating
COLH_C        Mother around but not participating
WDAYWEND      Indicates weekday or weekend

The chunk below imports the data, appends both waves into one dataset (after renaming), and fills in some missing values.

```{r}
# 300-399 is obtaining goods/services (remove?)
# 919 tv
T0 <- read.csv("~/Dropbox/PSID_CDS/PSID_RAW/TD97full.csv") %>%
  mutate(KID=ER30001*1000 + ER30002,year = 1997) %>%
  select(KID,year,COLA,COLG_B,COLG_C,COLH_B,COLH_C,WDAYWEND,DURATION)



T1 <- read.csv("~/Dropbox/PSID_CDS/PSID_RAW/TD02full.csv") %>%
  mutate(KID=ER30001*1000 + ER30002,year = 2002) %>%
  rename(COLG_B = COLGB_02, COLG_C = COLGC_02 , COLH_B = COLGH_02, COLH_C = COLHC_02, WDAYWEND = DIARY_02, DURATION = DUR_02, COLA = COLA_02) %>%
  select(KID,year,COLA,COLG_B,COLG_C,COLH_B,COLH_C,WDAYWEND,DURATION) %>%
  mutate(COLA = floor(COLA/10)) #<- have to round down

TD <- rbind(T0,T1) %>%
  mutate(time2ind = COLA!=919) %>% #<- is this right?
  #mutate(time2ind = (COLA>=500 & COLA<600) | (COLA>=700 & COLA<900) | (COLA>=939 & COLA<960)) #%>% #<- is this right?
  #mutate(cat = floor(COLA/100))
  mutate(COLG_B = na_if(COLG_B,9),COLG_C = na_if(COLG_C,9),COLH_B = na_if(COLH_B,9), COLH_C = na_if(COLH_C,9)) #<- code in missing categories
```

We want a file that for each year and child, contains the total active time for mothers and fathers. Eventually, we also want to look at this disaggregated. We also want to look at total time invested.

When aggregating to a weekly estimate, we'll add a weight of 5 to weekdays, and 2 to weekends.
```{r}
TD$wght = 2 + 3*TD$WDAYWEND
```

Now we create the means of active time, measured in hours per week. Our main measures, *tau_m* and *tau_f*, sum up all activity times with parents actively participating. The alternatives *tau_m2* and *tau_f2* do the same thing but exclude TV watching from the list of categories.

```{r}
TD_agg <- TD %>% 
  group_by(KID,year) %>% 
  summarise(tau_m = sum(DURATION*wght*COLG_B,na.rm = TRUE)/3600, tau_f = sum(DURATION*wght*COLG_C,na.rm=TRUE)/3600, tau_both = sum(DURATION*wght*(COLG_B + (1-COLG_B)*COLG_C),na.rm=TRUE)/3600, tau_m2 = sum(time2ind*DURATION*wght*COLG_B,na.rm = TRUE)/3600, tau_f2 = sum(time2ind*DURATION*wght*COLG_C,na.rm=TRUE)/3600)
```

Now let's write this file. 

```{r}
write.csv(TD_agg,"~/Dropbox/PSID_CDS/PSID_CLEAN/ActiveTimePanel.csv")
```

# Child-Specific Expenditures
## First Round of Expenditures
We're just looking at 2002 data for now. 2007 is also available. All of these expenditure variables come from the *Primary Caregiver Interview*. For convenience here is a summary of the variables.

Vname      Variable Description
---------- ------------------------------------------
ER30001    1968 INTERVIEW NUMBER                   
ER30002    PERSON NUMBER                         68
ER33601    2001 INTERVIEW NUMBER                   
ER33602    SEQUENCE NUMBER                       01
ER33603    RELATION TO HEAD                      01
CHREL      PCG CHILD FILE RELEASE NUMBER 02        
Q21H23A    SPEND ON TOYS 02                        
Q21H23A1   AMT SPENT ON TOYS 02                    
Q21H23B    SPEND ON VACATION 02                    
Q21H23B1   AMT SPENT OF VACATION 02                
Q21H23C    SPEND ON SCH SUPPLIES 02                
Q21H23C1   AMT SPENT OF SCH SUPPLIES 02            
Q21H23D    SPEND ON CLOTHES 02                     
Q21H23D1   AMT SPENT ON CLOTHES 02                 
Q21H23H    SPEND ON FOOD 02                        
Q21H23H1   AMT SPENT ON FOOD 02                    

These questions can be found together in the PCG interview. Other questions are asked later on about private lessons and so on, we have those in a separate file so we will clean them separately.

First we read in the data, create the child identifier, and replace some of the missing values for each category. 
```{r}
E = read.csv("~/Dropbox/PSID_CDS/PSID_RAW/Exp2002.csv") 
E[E>=99998] <- NA
E <- E %>%
  mutate(KID = ER30001*1000 + ER30002)
```

Now we need to drop the zeros from expenditure variables that correspond to the PCG not knowing whether money was spent or not. We then convert our measures to weekly.

```{r}
E[(E$Q21H23A>=8),"Q21H23A1"]<-NA
E[E$Q21H23B>=8,"Q21H23B1"]<-NA
E[(E$Q21H23C>=8) | (E$Q21H23C1>=9998),"Q21H23C1"]<-NA
E[(E$Q21H23D>=8) | (E$Q21H23D1>=9998),"Q21H23D1"]<-NA
E[E$Q21H23H>=8,"Q21H23H1"]<-NA

E <- E %>%
  rename(Toys = Q21H23A1, Vacation = Q21H23B1, SchSupplies = Q21H23C1, Clothing = Q21H23D1, Food = Q21H23H1) %>%
  mutate(Toys = Toys/52, Vacation = Vacation/52, SchSupplies = SchSupplies/52, Clothing = Clothing/52, Food = Food/52)


```

## Second Round of Expenditures
The PCG interview also contains questions on expenditures in 2002 on lessons, private school tuition, tutoring, sports, and community groups. The variables of interest are:

Vname      Variable Description
---------- -----------------------------------------
Q21B12_2   PRIV SCH PREV YR 02                     
Q21B12A1   SCH COSTS PREV YR - AMT 02              
Q21B12A2   SCH COSTS PREV YR - PER 02              
Q21G5      IN TUTORING PROGRAM 6-9 YRS 02          
Q21G5D     COST OF TUTORING 6-9 YRS 02             
Q21G7A     TAKE LESSONS 6-9 YRS 02                 
Q21G7C     COST OF LESSONS 6-9 YRS 02              
Q21G8F     INVOLVD IN SPORTS LAST SCH YR 6-9 YRS 02
Q21G8I     COST OF SPORTS PAST 12 MTHS 6-9 YRS 02  
Q21G10     MEMBER OF COMMUNITY GRPS 6-9 YRS 02     
Q21G10C    COST OF COMMUNITY GRPS 6-9 YRS 02       
Q21H5      IN TUTORING PROGRAM 10+ YRS 02          
Q21H5C     COST OF TUTORING 10+ YRS 02             
Q21H6      TAKE LESSONS 10+ YRS 02                 
Q21H6B     COST OF LESSONS 10+ YRS 02              
Q21H7B     INVOLVD IN SPORTS LAST SUMMER 10+ YRS 02
Q21H7F     COST OF SPORTS PAST 12 MTHS 10+ YRS 02  
Q21H8      MEMBER OF COMMUNITY GRPS 10+ YRS 02     
Q21H8B     COST OF COMMUNITY GRPS 10+ YRS 02     

We first read the data and replace missing values.

```{r}
E2 <- read.csv("~/Dropbox/PSID_CDS/PSID_RAW/Exp2002v2.csv")
E2[E2==9998] <- NA
E2[E2==9999] <- NA
E2[E2==99998] <- NA
E2[E2==99999] <- NA

```

Next we rename the variables, convert each of them to a weekly measure, and merge with the first round of questions. Finally, we create a total that sums school supplies, toys, sports, tutoring, lessons, and community groups.
```{r}
E <- E2 %>%
  mutate(KID = ER30001*1000 + ER30002,tutoring = Q21G5D + Q21H5C) %>%
  mutate(comm_grps = (Q21G10C + Q21H8B)/52) %>%
  mutate(sports = (Q21G8I + Q21H7F)/52) %>%
  mutate(tutoring = (Q21G5D + Q21H5C)/52) %>%
  mutate(lessons = (Q21G7C + Q21H6B)/52) %>%
  mutate(tuition = Q21B12A1) %>%
  mutate(tuition = case_when(Q21B12A2==3 ~ 50*tuition,Q21B12A2==5 ~ 12*tuition, TRUE ~ tuition)/52) %>%
  select(KID,sports,lessons,comm_grps,tutoring,tuition) %>%
  merge(E) %>%
  mutate(Exp = SchSupplies+Toys+sports+lessons+tutoring+lessons+comm_grps)

```


""

Finally, let's relate this to 2002, and write to file.

```{r}
E$year <- 2002
cols <- c("KID","year","Toys","Vacation","SchSupplies","Clothing","Food","sports","lessons","comm_grps","tutoring","tuition")
write.csv(E[,cols],"~/Dropbox/PSID_CDS/PSID_CLEAN/Expenditures.csv")

```


# Child Care

## Child care Expenditures from CDS
In 2002/2007, the interview distinguishes between weekday and weekend care options (which the 1997 wave does not). Since there were very few responses to the weekend care question, we are just using weekday care. In addition, since there were very few responses given beyond the 1st care option, we are only using those data.

For convenience the 1997 variables are that we use are tabulated below.

Vname      Variable Description
---------- -----------------------------------------
ER30001    1968 INTERVIEW NUMBER                   
ER30002    PERSON NUMBER                         68
ER33401    1997 INTERVIEW NUMBER                   
ER33402    SEQUENCE NUMBER                       97
ER33403    RELATION TO HEAD                      97
CHREL97    PCG CHILD FILE RELEASE NUMBER 97        
Q1H14      MOST USED ARRNGMNT 97                   
Q1H18      USUAL ARRNGMNT-DAYS PER WEEK 97         
Q1H19      USUAL ARRNGMNT-HRS PER WEEK 97          
Q1H21      USUAL ARRNGMNT-COST 97                  
Q1H21A     USUAL ARRNGMNT-PAYMENT RATE 97          
Q1H22      USUAL ARRNGMNT-OTHER CHILDREN 97        
Q1H22A     USUAL ARRNGMNT-# OF OTHER CHILDREN 97   

For now, let's just create data on expenditures for each year. In 1997, the cost was reported in one of several units: (1) hourly (2) daily (3) weekly (4) fortnightly (5) monthly (6) annual. We standardize this into a weekly measure. We also derive an hourly price using the weekly cost and hours per week, as well as an indicator for the type of arrangement being used.

```{r}
Ch <- read.csv("~/Dropbox/PSID_CDS/PSID_RAW/Childcare.csv") %>% #<- read in the data
  mutate(KID = ER30001*1000 + ER30002) %>%
  mutate(Q1H21 = case_when(Q1H21<9998 ~ Q1H21),Q1H18 = case_when(Q1H18<8 ~ Q1H18),Q1H19=case_when(Q1H19<998 ~ Q1H19),Q1H21A=case_when(Q1H21A<8 ~ Q1H21A)) %>% #<- fill in missing values 
  mutate(chcareExp97 = case_when(Q1H21A==1 ~ Q1H21*Q1H19, #, #<- cost reported hourly
                                 Q1H21A==2 ~ Q1H21*Q1H18,  #<- reported daily
                                 Q1H21A==4 ~ Q1H21/2, #<- reported fortnightly
                                 Q1H21A==5 ~ Q1H21/(52/12), #<- reported monthly
                                 Q1H21A==6 ~ Q1H21/52, #<-reported annually
                                 TRUE ~ Q1H21)) %>% #<- reported weekly
  mutate(Price97 = chcareExp97/Q1H19) %>% #<- derive price
  mutate(Arrange97 = case_when(Q1H14==1 | Q1H14==2 | Q1H14==4 ~ "Relative",
                               Q1H14==3 ~ "Non Relative",
                               Q1H14==5 ~ "Family Center",
                               Q1H14==7 ~ "Care Center",
                               Q1H14==8 ~ "Before/After School Prog."))

```

The chunk of code below does the same thing for the 2002 PCG interview. For reference, here are the variables.

Vname      Variable Description
---------- ----------------------------------------
ER33601    2001 INTERVIEW NUMBER                   
ER33602    SEQUENCE NUMBER                       01
ER33603    RELATION TO HEAD                      01
CHREL      PCG CHILD FILE RELEASE NUMBER 02        
Q21C12     WKDAY: CARE USED MOST 02                
Q21C13     WKDAY: HRS PER WK 02                    
Q21C15A    WKDAY: COST OF CARE - AMT 02            
Q21C15B    WKDAY: COST OF CARE - UNIT 02           
ER33901    2007 INTERVIEW NUMBER                   
ER33902    SEQUENCE NUMBER                       07
ER33903    RELATION TO HEAD                      07
PCHREL07   PCG CHILD FILE RELEASE NUMBER 07        
Q31C12     WKDAY: CARE USED MOST 07                
Q31C13     WKDAY: HRS PER WK 07                    
Q31C15A    WKDAY: COST OF CARE - AMT 07            
Q31C15B    WKDAY: COST OF CARE - UNIT 07           

Unlike in 1997, there is no variable that reports the number of days per week. Therefore, to impute the weekly cost when a daily rate is reported, we use the average number of hours per day reported among those that use an hourly rate, and combine this with the hours per week report to get the number of days.

From 1997, we calculate the average number of hours per day as:
```{r}
hours_per_day <- Ch %>% filter(Q1H18>0) %>% summarise(mean(Q1H19/Q1H18,na.rm = TRUE))
hours_per_day[1,1]
```
So we get that childcare is used on average for about 3.1 hours per day. The imputed number of days per week is therefore
\[Days/Week = (Hours/Week)/(Hours/Day) = (Hours/Week)/3.1\]


```{r}

Ch <- Ch %>%
  mutate(Q21C15A = case_when(Q21C15A<9998 ~ Q21C15A),Q21C13=case_when(Q21C13<998 ~ Q21C13),Q21C15B=case_when(Q21C15B<8 ~ Q21C15B)) %>% #<- fill in missing values 
  mutate(chcareExp02 = case_when(Q21C15B==1 ~ Q21C15A*Q21C13, #<- cost reported hourly
                                 Q21C15B==2 ~ Q21C15A*Q21C13/3.1, #<- reported daily?
                                 Q21C15B==4 ~ Q21C15A/2, #<- reported fortnightly
                                 Q21C15B==5 ~ Q21C15A/(52/12), #<- reported monthly
                                 Q21C15B==6 ~ Q21C15A/52,#<-reported annually
                                 TRUE ~ Q21C15A)) %>% #<- reported weekly
  mutate(Price02 = chcareExp02/Q21C13) %>% #<- derive hourly price
  mutate(Arrange02 = case_when(Q21C12==1 | Q21C12==2  ~ "Relative",
                               Q21C12==3 ~ "Non Relative",
                               Q21C12==5 ~ "Family Center",
                               Q21C12==7 ~ "Care Center",
                               Q21C12==8 ~ "Before/After School Prog."))

```


One issue is that in 1997, there is a question about whether the arrangement covers other children, and the number. It seems that often it does. It doesn't appear that the same question is asked in 2002/2007. Currently we are not attempting to normalize by the number of children covered in the arrangement.

### Collecting Data for Younger Children
In addition, for children younger than 5, the data were collected somewhat differently in 1997. These were done as part of retrospective history of child care use. To use these data we first have to clean the history to find current arrangements. Then we put all the data together. The variables are:

Vname      Variable Description
---------- ----------------------------------------
Q1H1Y      AGE 1ST CARED BY SOMEONE ELSE (YRS) 97  
Q1H1M      AGE 1ST CARED BY SOMEONE ELSE (MTHS) 97 
Q1H1A      BEFORE/AFTER K'GARTEN 97                
Q1H2_1     ARRNGMNT #1-REASON 97                   
Q1H3_1Y    ARRNGMNT #1-AGE START (YRS) 97          
Q1H3_1M    ARRNGMNT #1-AGE START (MTHS) 97         
Q1H4_1     ARRNGMNT #1-TYPE 97                     
Q1H5_1     ARRNGMNT #1-DAYS PER WEEK 97            
Q1H6_1     ARRNGMNT #1-HRS PER WEEK 97             
Q1H7_1     ARRNGMNT #1-COST 97                     
Q1H7A_1    ARRNGMNT #1- PAYMENT RATE 97            
Q1H7B_1    ARRNGMNT #1-OTHER CHILDREN 97           
Q1H7C_1    ARRNGMNT #1-# OF OTHER CHILDREN 97      
Q1H8_1Y    ARRNGMNT #1-AGE STOP (YRS) 97           
Q1H8_1M    ARRNGMNT #1-AGE STOP (MTHS) 97          
Q1H9_1     ARRNGMNT #1-REASON STOP 97              
Q1H10_1    ARRNGMNT #1-OTHER ARRNGMNTS 97     


```{r}
     
# this function calculates the weekly rate given the data
CalcRate <- function(varname,rate,cost,days,hours,Ch) {
  I_miss <- Ch[,cost]>=99998
  Ch[I_miss,cost] <- NA
  Ch[,varname] <- Ch[,cost]
  # Case 0: Weekly
  Ic = (Ch[,rate]==3)
  Ch[Ic,varname] = Ch[Ic,cost]
  # Case 1: Hourly
  Ic = (Ch[,rate]==1)
  Ch[Ic,varname] = Ch[Ic,cost]*Ch[Ic,hours]
  # Case 2: Daily
  Ic = (Ch[,rate]==2)
  Ch[Ic,varname] = Ch[Ic,cost]*Ch[Ic,days]
  # Case 4: Fortnightly
  Ic = (Ch[,rate]==4)
  Ch[Ic,varname] = Ch[Ic,cost]/2
  # Case 5: Monthly
  Ic = (Ch[,rate]==5)
  Ch[Ic,varname] = Ch[Ic,cost]/4
  # Case 6: Annual
  Ic = (Ch[,rate]==6)
  Ch[Ic,varname] = Ch[Ic,cost]/52
  Ch
}


ch_hist <- readxl::read_excel("~/Dropbox/PSID_CDS/PSID_RAW/Childcare_history.xlsx") %>%
  mutate(KID = ER30001*1000 + ER30002)


for (i in seq(1,8)) {
  vname = paste("exp97_",i,sep="")
  rate = paste("Q1H7A_",i,sep="")
  cost = paste("Q1H7_",i,sep="")
  days = paste("Q1H5_",i,sep="")
  hours = paste("Q1H6_",i,sep="")
  # replace missing hours with NA:
  ch_hist[,hours] = na_if(ch_hist[,hours],998)
  ch_hist[,hours] = na_if(ch_hist[,hours],999)
  ch_hist <- CalcRate(vname,rate,cost,days,hours,ch_hist)
}

ch_hist$Arrange <- -1
ch_hist$Freq <- 0
ch_hist$Exp97 <- -1
ch_hist$Hours97 <- -1
ch_hist$Exp97Tot <- 0
ch_hist$Hours97Tot <- 0

for (i in seq(1,nrow(ch_hist))) {
  if (ch_hist[i,"Q1H1Y"]==0) {
    ch_hist[i,"Arrange"] = 0
  }
  else {
    for (j in seq(1,8)) {
      if (ch_hist[i,paste("Q1H8_",j,"Y",sep="")]==96) {
        freq_var = paste("Q1H5_",j,sep="")
        ch_hist[i,"Exp97Tot"] = ch_hist[i,"Exp97Tot"] + ch_hist[i,paste("exp97_",j,sep="")]
        ch_hist[i,"Hours97Tot"] = ch_hist[i,"Hours97Tot"] + ch_hist[i,paste("Q1H6_",j,sep="")]
        days_per_week = ch_hist[i,freq_var]
        if (days_per_week>ch_hist[i,"Freq"] & days_per_week<8) {
          ch_hist[i,"Arrange"] = ch_hist[i,paste("Q1H4_",j,sep="")]
          ch_hist[i,"Freq"] = ch_hist[i,freq_var]
          ch_hist[i,"Exp97"] = ch_hist[i,paste("exp97_",j,sep="")]
          ch_hist[i,"Hours97"] = ch_hist[i,paste("Q1H6_",j,sep="")]
        }
      }
    }
  }
}

# now code up arrangements:
# - Childcare arrangements
ch_hist$Arrange97 <- NA
I1 <- ch_hist$Arrange==0
ch_hist$Arrange97[I1] <- "Never Cared for By Other"
I1 <- is.na(ch_hist$Arrange)
ch_hist$Arrange97[I1] <- "No Detectable Arrangement"
I1 <- ch_hist$Arrange==1 | ch_hist$Arrange==3
ch_hist$Arrange97[I1] <- "Relative"
I1 <- ch_hist$Arrange==2 | ch_hist$Arrange==4
ch_hist$Arrange97[I1] <- "Non Relative"
I1 <- ch_hist$Arrange==5
ch_hist$Arrange97[I1] <- "Head Start"
I1 <- ch_hist$Arrange==6
ch_hist$Arrange97[I1] <- "Care Center"
I1 <- ch_hist$Arrange==7
ch_hist$Arrange97[I1] <- "Before/After School Prog."
I1 <- ch_hist$Arrange==8
ch_hist$Arrange97[I1] <- "Self Care"
I1 <- ch_hist$Arrange>=97
ch_hist$Arrange97[I1] <- "Unkown Type"

# code a more basic breakdown:
ch_hist$CaretypeBroad <- "External"
ch_hist$CaretypeBroad[ch_hist$Arrange==0] <- "Never Care for by Other"
ch_hist$CaretypeBroad[is.na(ch_hist$Arrange)] <- "No Current Detectable"
  
ch_hist %>% select(KID,CaretypeBroad,Arrange97,Exp97Tot,Hours97Tot,Arrange,Hours97,Exp97) %>%
  mutate(Arrange = na_if(Arrange,-1),Exp97 = na_if(Exp97,-1),Hours97=na_if(Hours97,-1)) %>%
  write.csv("~/Dropbox/PSID_CDS/PSID_CLEAN/ChildcarePreK97.csv")

```

Next we merge these data with the rest to create a panel.

```{r}
C97 <- Ch[,c("KID","chcareExp97","Arrange97","Price97")]
C97$year <- 1997
C97 <- rename(C97,chcare = chcareExp97,Arrange = Arrange97, Price = Price97)
# now load preK data and merge, replacing the child care value with this value when available
C97 <- ch_hist %>%
  select(KID,Exp97Tot) %>%
  mutate(Exp97Tot = na_if(Exp97Tot,9998)) %>%
  merge(C97) %>%
  mutate(chcare = case_when(Exp97Tot>0 ~ Exp97Tot,TRUE ~ chcare)) %>%
  select(-Exp97Tot)


C02 <- Ch[,c("KID","chcareExp02","Arrange02","Price02")]
C02$year <- 2002
C02 <- rename(C02,chcare = chcareExp02,Arrange = Arrange02, Price = Price02)

Cpanel <- rbind(C97,C02) 

write.csv(Cpanel,"~/Dropbox/PSID_CDS/PSID_CLEAN/ChildCarePanel.csv")

```


## Child care expenditures from PSID Main Interview

In addition to the child-specific child care expenditure measures from the CDS, the main interview of the PSID also asks about total child care expenditures for the year. The chunk of code below imports this data and creates a vertical dataset that relates each year and interview number within that year to a response. This can be merged to individuals using the *Cross-Year Individual File* (see below). The codebook can be found [here](~/Dropbox/PSID_CDS/PSID_RAW/Main_childcare_codebook.html).

```{r}
D <- readxl::read_excel("~/Dropbox/PSID_CDS/PSID_RAW/Main_childcare.xlsx")

# these are all the years that the question is available
years <- c(seq(1988,1997),seq(1999,2017,2))

d <- data.frame(year = integer(), intnum = integer(), childcare_exp = double())

for (i in 1:length(years)) {
  d0 <- data.frame(year = years[i], intnum = D[[(i-1)*3+2]], childcare_exp = D[[(i-1)*3+3]])
  d <- rbind(d,na.omit(d0))
}

# code up missing values
d$childcare_exp[(d$childcare_exp>=99998) & d$year<1999] <- NA
d$childcare_exp[(d$childcare_exp>=999998)] <- NA

write.csv(d,"~/Dropbox/PSID_CDS/PSID_CLEAN/Main_childcare.csv")
```

These data can be used to impute missing child care expenditure observations for individuals.

# Per Pupil Expenditure for the Child's School

When possible, as part of the CDS supplement, the PSID conducted interviews with the Middle and Elementary School administrators. The data below cleans all available data on reported per pupil expenditure for the school.

```{r}
PPE <- readxl::read_excel("~/Dropbox/PSID_CDS/PSID_RAW/CDS_PPE.xlsx") %>%
  mutate(KID = ER30001*1000 + ER30002) %>%
  rename(PPE = Q12A27) %>%
  mutate(PPE = case_when(PPE<99998 ~ PPE)) %>% #<- code in missing values
  select(KID,PPE) %>%
  mutate(year = 1997) #<- add the year for merging into a panel.

write.csv(PPE,"~/Dropbox/PSID_CDS/PSID_CLEAN/PPE.csv")
```

# Cognitive Assessments

The CDS administers the *Woodcock Johnson* aptitude test, which contains several components including a *Letter-Word* (LW) score, an *Applied Problems* (AP) score, and a *Passage Comprehension* (PC) score. A digit spand assessment is used to younger children, while two indices of behavioral problems are created  using the PCG's answers to certain behavior questions. The chunk of code below cleans the raw data downloaded directly from the PSID and arranges it into a panel over the years 1997, 2002, and 2007. These are calendar *and* interview years, unlike some of the other PSID variables.

The cleaned data includes both raw and standardized scores for LW, AP, and PC.

```{r}
D <- readxl::read_excel("~/Dropbox/PSID_CDS/PSID_RAW/ChildAssessments.xlsx") %>% 
  mutate(KID = ER30001*1000 + ER30002)

# first we want to arrange the data nicely. We have the same scores for each year. They are:
col_names <- c("LW_std","LW_raw","PC_std","PC_raw","AP_std","AP_raw","DigSpan","BPE","BPN")

# 3 vectors with the corresponding variable names for each year
names97 <- c("Q3LW_SS","Q3LWRAW","Q3PC_SS","Q3PCRAW","Q3AP_SS","Q3APRAW","Q3DSTOT","BPI_E97","BPI_N97")

names02 <- c("Q24LWSS","Q24LWRAW","Q24PCSS","Q24PCRAW","Q24APSS","Q24APRAW","Q24DSTO","BPI_E02","BPI_N02")

names07 <- c("Q34LWSS","Q34LWRAW","Q34PCSS","Q34PCRAW","Q34APSS","Q34APRAW","Q34DSTO","BPI_E07","BPI_N07")

# separate and recombine files in a panel
D97 <- D[,c("KID",names97)]
names(D97)[2:10] <- col_names
D97$year <- 1997

D02 <- D[,c("KID",names02)]
names(D02)[2:10] <- col_names
D02$year <- 2002

D07 <- D[,c("KID",names07)]
names(D07)[2:10] <- col_names
D07$year <- 2007

A <- rbind(D97,D02,D07)

# Finally, replace missing values
missvals <- c(999,99,999,99,999,99,99,99,99)
for (i in 1:9) {
  A[,col_names[i]] <- na_if(A[,col_names[i]],missvals[i])
}

write.csv(A,"~/Dropbox/PSID_CDS/PSID_CLEAN/AssessmentPanel.csv")

```


# Creating a Panel Dataset
In the previous sections we cleaned the PSID data that we wish to use for the main analysis. In this section we construct a panel of observations built around mothers in the PSID, wherein we apply a number of sample restrictions.

## Fertility History Panel

We start by loading the childbirth history file, which we will use to identify mothers and arrange their fertility history into a panel dataset. It will be useful to know the following mapping between variable names and variables:

Vnum     Vname
-------  ----------------------
CAH3     intnum68
CAH4     pernum
CAH5     sex
CAH6     parent month of birth
CAH7     parent year of birth
CAH8     marital status when born
CAH9     birth order
CAH10    child intnum
CAH11    child pernum
CAH12    sex of child
CAH13    child month of birth
CAH15    child year of birth
CAH108   number of birth records

The chunk below loads these data and applies some sample restrictions:
 - Drop women without recorded births
 - Drop women with missing birth year information
 - Drop women with missing information in their childbirth history
 - Keep only women whose children appear in the CDS
 
For the last sample restriction, we use a non-local file that indexes each mother and each child of theirs that appears in the CDS called "MotherIndex.csv".

```{r}
cds <- read.csv("~/Dropbox/PSID_CDS/PSID_RAW/MotherIndex.csv") %>% select(c("MID")) %>% unique() #<- this file contains all the women whose children end up in the CDS

C = read.csv("~/Dropbox/PSID_CDS/PSID_RAW/Childbirth.csv") %>% mutate(X = NULL) %>% #<- load childbirth file
  filter(CAH5==2)  %>% #keep only women
  filter(CAH10!=0) %>% # drop women who have no children according to this file
  filter(CAH7!=9998) %>% # drop women with missing birth year info
  mutate(MID = CAH3*1000 + CAH4, KID = CAH10*1000 + CAH11) %>% #<- create identifier for mother and child
  group_by(MID) %>%
  filter(!any(CAH10 == 9999)) %>% #<- drop women with unknown adoption or birth record
  inner_join(cds)


#Link mother's standardized and raw passage comprehension scores from the 1997 PCG interview to mother's. 

m_pc97 <- read.csv("~/Dropbox/PSID_CDS/PSID_RAW/MotherPC.csv") %>% 
  mutate(KID = ER30001*1000 + ER30002) %>% 
  select(KID,Q1PCSS,Q1PCRAW,PCG)%>%
  rename(m_pc_st= Q1PCSS, m_pc_raw= Q1PCRAW)

#Replace missing values to NA and keep only scores reported by mothers of the child
var <- c("m_pc_st", "m_pc_raw")
missing <- c(0, 99)
for (i in 1:2) {
  m_pc97[,var[i]] = na_if(m_pc97[,var[i]],missing[i])
  m_pc97[,var[i]] = ifelse(m_pc97$PCG==1,m_pc97[,var[i]],NA)
}
m_pc97<-m_pc97 %>% select(KID,m_pc_st,m_pc_raw)
write.csv(m_pc97,"~/Dropbox/PSID_CDS/PSID_CLEAN/AssessmentMother.csv")
# Merge mother's score with mother's panel
m_pc97 <- merge(x=C,y=m_pc97,by="KID",all=TRUE)%>% group_by(MID) %>%
select(MID,m_pc_st,m_pc_raw) %>% drop_na(m_pc_st,m_pc_raw) %>%distinct(MID, .keep_all= TRUE)


```
 
We want a panel dataset that begins when each mother turns 18 and ends in 2017. Each individual-year observation has the number of dependent children, the age of the youngest child, the number of children between 0 and 5, annd the number of children between 6 and 12.

The function below does this assuming that the dataframe $d$ contains the childbirth data for just one mother:

```{r}
MakePanel <- function(d) {
  year <- (d$CAH7[1]+18):2017
  Ny <- length(year)
  knum = d$CAH108[1]
  age_youngest <- integer(Ny) -1
  age_oldest <- integer(Ny) + Inf
  num_0_5 <- integer(Ny)
  num_6_12 <- integer(Ny)
  num_child <- integer(Ny)
  age_mother = year-d$CAH7[1]
  for (i in 1:length(year)) {
    ay = Inf
    ao = -1
    a5 = 0
    a6 = 0
    for (k in 1:nrow(d)) {
      agek = year[i]-d$CAH15[k]
      if (agek>=0 & agek<=18) {
        #print(agek)
        ay = min(ay,agek)
        ao = max(ao,agek)
        num_child[i]  = num_child[i] + 1
      }
      if (agek>=0 & agek<=5) {
        a5 = a5 + 1
      }
      if (agek>5 & agek<=12) {
        a6 = a6 + 1
      }

    }
    age_youngest[i] = ay
    age_oldest[i] = ao
    num_0_5[i] = a5
    num_6_12[i] = a6
  }
  data.frame(MID = d$MID[1], age_mother=age_mother, year = year, knum = knum, num_child=num_child,age_youngest=age_youngest,age_oldest=age_oldest, num_0_5 = num_0_5, num_6_12 = num_6_12, y_first = d$CAH15[1])
}

```

The chunk below applies the function for each mother (defined by their ID number *MID*) which results in a panel dataset. In order to speed up analysis, we also drop observations that we know will be too early for the CDS (everyone with first births before 1960).

```{r}

D <- C %>% group_by(MID) %>% do(MakePanel(.)) %>% filter(y_first>=1960) %>%
left_join(m_pc97) # Add mother's cognitive score
```

## Merge in State Identifiers and Childcare Expenditures

We start by merging this panel with the Individual Cross-Year File, which maps an (ID,year) combination with an interview number and sequence number (which allows us to link with state codes and household child care expenditures)

This chunk loads the individual file and creates the ID number:
```{r}
Ind = read.csv("~/Dropbox/PSID_CDS/PSID_RAW/IndFileVertical.csv") %>% 
  mutate(X = NULL) %>% 
  mutate(MID = intnum68*1000 + pernum,mar_stat = mpair>0)

```

Since we would like to see marital status in some non-interview years, we use the following year's marital status:

```{r}
Ind <- Ind %>% filter(year>=1999) %>% 
  mutate(year = year - 1) %>%
  rbind(Ind)
```
This method of imputation ensures that we only fill in missing data from non-interview years.

One thing that will be useful throughout is a panel with the mother's ID linked to their interview and calendar year. Some variables from the main interview refer to the previous year and things can get messy, so we use this file to keep things consistent.
```{r}
# this will be useful throughout: create a dataframe that maps mothers to their interview number and sequence number
D_Ind <- D %>%
  inner_join(Ind)
```

Next we load in a panel of state codes, which we merge with the cross-year individual file. We then merge that file with a state code cross-walk so that we can link the PSID's state code with FIPS and SOI. We also merge, based on the household interview number and year, annual household expenditures on child care (cleaned in a previous section).

Finally, this file is merged with the panel of mothers we just created, using years before and after to fill in missing state observations.

```{r}
# state codes measures residence for survey year
state_codes = read.csv("~/Dropbox/JPE_Child_Devp_2020/OtherData/StateCodes.csv") %>% mutate(X=NULL,X.1 = NULL) %>% #<- this is a simple crosswalk of state codes
  select(-state) %>% 
  rename(state = PSID, StFIPS = fips) %>% #<- we rename some things in order to do the merge properly
  select(state,StFIPS,SOI)


# child care expenditures are for previous year, so we have to be careful how we do the merge!
# we merge by survey year then subtract one year to make the reference correct
# then we drop intnum, using only MID and year to link with the main file in the next step
ch_care <- read.csv("~/Dropbox/PSID_CDS/PSID_CLEAN/Main_childcare.csv") %>% 
  mutate(X=NULL) #%>%
  inner_join(D_Ind) %>% #<- merge to mother's through the panel file
  mutate(year = year-1) %>% #<- convert survey year to lag year
  select(MID,year,childcare_exp)


D <- read.csv("~/Dropbox/PSID_CDS/PSID_RAW/StateVertical.csv") %>% #<- state of residence panel data
  mutate(X=NULL) %>%
  right_join(Ind) %>% #<- merge with Individual file
  right_join(D) %>% #<- merge with the panel we created (keeping all years)
  arrange(MID,year) %>%
  group_by(MID) %>%
  fill(state,.direction = "downup") %>% #<- fill in missing observations
  merge(state_codes) %>% #<- merge in the cross-walk with FIPS codes and SOI codes
  left_join(ch_care) #<= use only the main file to link
```

## Identify and Merge in Spouses ("Fathers")

The next step is to identify spouses for each mother in each year. Spouses are linked by the *mpair* variable which is unique within a household interview. We identify partners by:
1. Merging the individual file with the triple (*MID*,*year*,*age_mother*) from the panel, keeping all observations from the individual file.
2. Partners are identified by the fact that they are not successfully matched in this merge, meaning that *age_mother* will be missing. We keep those observations and rename the variables in order to merge them once more with the panel of mothers.

```{r}
D <- D %>%
  select(MID,year,age_mother) %>%
  right_join(Ind) %>% #<- merge with individual file, keep all observations from Ind
  filter(is.na(age_mother)) %>% #<- identify spouses by missing info from the merge
  rename(FID=MID,snF=sn) %>% #<- rename variables for merge
  filter(mpair>0) %>% #<- only keep individuals who are not mothers but who are in a relationship in the same household
  select(FID,year,intnum,mpair,snF) %>%
  right_join(D) %>% #<- do the merge
  mutate(snF = replace_na(snF,-1)) #<- replace missing values.


```

## Merge in Spouse Birth Year and Marriage Summary Variables

The *Marriage History File* is prepared by the PSID and contains a record of each marriage in the PSID. We use this file to determine which individuals have ever been married, to filter out individuals with missing marriage information, and to identify the birth year of spouses.

First we load the marriage file and create an "ever" married summary variable. We finish by merging this file with the main panel (based on MID)

```{r}
# #  ---- load marriage info and create some summary variables
M <- read.csv("~/Dropbox/PSID_CDS/PSID_RAW/Marriage.csv") %>%
  mutate(X = NULL) %>%
  rename(MID = ID1) %>% #<- we rename to MID in preparation for a first merge with sample mothers
  rename(ybirth = MH6) %>%
  filter(ybirth<9998) %>% #<- drop individuals with missing birth info
  rename(ymar = MH11) %>%
  filter(ymar!=9998) %>% #<- remove individuals without marriage info
  mutate(record = ymar<9999) %>% #<- ymar==9999 indicates never married
  group_by(MID) %>%
  summarise(ever_married = sum(record)>0,ybirth = ybirth[1])

D = M %>% 
  inner_join(D)


```

We also use this file to merge with FID for each spouse to deduce the spouse's age. This means we don't have the spouse's age for cohabiting couples. We use the triple *year*, *intnum* and *mpair* to match women with their spouses. To do this, we first create an individual index file of people that are *not* women in the sample. This is the potential pool of fathers that we use for the merge.

```{r}

D <- D_Ind %>%
  select(MID,year,age_mother) %>%
  right_join(Ind) %>%
  filter(is.na(age_mother)) %>% #<- pick out individuals from the merge who were *not* matched
  rename(FID = MID,snF = sn) %>%
  select(c("FID","year","intnum","mpair","snF")) %>%
  filter(mpair>0) %>%
  right_join(D)

D <- M %>%
  rename(FID=MID,ybirthF = ybirth) %>%
  right_join(D) %>%
  mutate(f_age = year - ybirthF)

```


## Merge in Mother's Race, Education, and CPI (external)
In the current version we don't use CPI, but we'll put it in anyway. Race and education are previously cleaned summary variables stored non-locally. We drop mothers from the sample with missing information on education and race.

```{r}
R <- read.csv("~/Dropbox/PSID_CDS/PSID_RAW/RaceHorizontal.csv") %>% mutate(X = NULL) %>% 
  rename(MID = ID)

educ = read.csv("~/Dropbox/PSID_CDS/PSID_RAW/HGC.csv") %>% 
  mutate(X = NULL,ID = intnum68*1000 + pnum68) %>%
  mutate(ed=case_when(hgc>16 ~ 5,hgc == 16 ~ 4, hgc>=13 ~ 3, hgc>=12 ~ 2, hgc<12 ~ 1)) %>%
  select(ID,ed) %>%
  mutate(ed = factor(ed,levels = c(1,2,3,4,5),labels=c("<12","12","13-15","16",">16")))
    
cpi = read.csv("~/Dropbox/PSID_CDS/CPI-U.csv") %>% 
  rename(year = YEAR) %>%
  mutate(CPIU = CPIU/CPIU[53])
  
```

Then we merge them into the main file.
```{r}
D <- D %>% #<- drop if mother has missing race or education info
  inner_join(R) %>% 
  inner_join(educ,by = c("MID" = "ID")) %>%
  rename(m_ed = ed) %>%
  left_join(educ,by = c("FID" = "ID")) %>%
  rename(f_ed = ed) %>%
  inner_join(R) %>%
  inner_join(cpi)
```

## Clean and Prepare Labor Market Data

Labor market earnings and hours come from the main interview of the PSID, which collects information for the "husband", the "wife" and other family members. Individuals can be matched to these variables via their sequence number in the household (which we will do below). First, let's load a cleaned panel dataset of these household data. 

```{r}
L = read.csv("~/Dropbox/PSID_CDS/PSID_RAW/LaborFile.csv") %>% mutate(X = NULL) #<- contains the hours and earnings of the "head" and the "wife" which can be matched to individuals via sequence number

```

Next, we merge with the main panel and assign wages, earnings, and hours, based on the mother's and father's sequence number, which tells us if they are either the "husband" or "wife" in the household.

```{r}
L <- D %>%
  select(MID,FID,year,intnum,sn,snF) %>% 
  inner_join(L) %>% #<- merge based on year and interview number
  mutate(m_hrs = case_when(sn==1 ~ h_hrs,sn==2 ~ w_hrs),m_earn = case_when(sn==1 ~ h_earn,sn==2 ~ w_earn)) %>%
  mutate(f_hrs = case_when(snF==1 ~ h_hrs,snF==2 ~ w_hrs),f_earn = case_when(snF==1 ~ h_earn,snF==2 ~ w_earn)) %>%
  mutate(m_wage = m_earn/m_hrs,f_wage = f_earn/f_hrs) %>%
  select(MID,year,m_earn,m_hrs,m_wage,f_earn,f_hrs,f_wage) %>% #<- we don't keep FID because the coupling MID,FID is dynamic and may not match the pair (MID,FID) from the previous year when we merge these data back in
  mutate(year = year - 1) #<- these variable refer to the previous year so we subtract one 

```


Since the PSID went to a biennial format after 1997, the file above does not have data for 1998,2000, and so on. A supplementary set of questions is asked about the family members from the previous year. These are sometimes called the "T2" supplement, which the chunk of code below cleans into a panel dataset for those missing years. These data were collected from the "Individual Data Index" from the PSID's data center tool, so they are linked to individuals already. The code below renames the variables and reshapes them into a panel. The reporting of earnings in these years is slightly different from the main questions, so we keep only observations that are reported in annual terms (the large majority). There is also an abnormally large increase in the number of individuals who report zero hours but positive earnings from 2001 and on. We have to correct for this using the T2 variables from the main interview file.

```{r}
# T2 <- readxl::read_xlsx("~/Dropbox/PSID_CDS/PSID_RAW/T2_alt.xlsx") %>%
#   mutate(MID = ER30001*1000 + ER30002,FID = MID) %>%
#   rename(earn_1997 = ER33536A,
# earnunit_1997 = ER33536B,
# wks_1997 = ER33536C,
# hrswk_1997 = ER33536Q,
# earn_1999=ER33627A,
# earnunit_1999=ER33627B,
# wks_1999=ER33627C,
# hrswk_1999=ER33627Q,
# earn_2001=ER33727A,
# earnunit_2001=ER33727B,
# wks_2001=ER33727C,
# hrswk_2001=ER33727Q ,
# earn_2003=ER33826A,
# earnunit_2003=ER33826B,
# wks_2003=ER33827S,
# hrswk_2003=ER33827U,
# earn_2005=ER33926A,
# earnunit_2005=ER33926B,
# wks_2005=ER33927A,
# hrswk_2005=ER33927C) #%>% #<- rename all the variables we want to use
#   select(FID,MID,starts_with("earn"),starts_with("hrs"),starts_with("wks")) %>%
#   pivot_longer(-c("MID","FID"),names_to = c(".value","year"),names_sep = "_") %>% #<- reshape into a panel
#   mutate(year = as.integer(year)) %>% #<- convert from string to integer
#   filter(earnunit==6) %>% #<- keep only reports of annual earnings 
#   mutate(hrs = hrswk*wks) #%>%
#   select(MID,FID,year,hrs,earn) %>%
#   mutate(earn = na_if(na_if(earn,earn==9999999),earn<0))



Dt2 <- read.csv("~/Dropbox/PSID_CDS/PSID_RAW/T2.csv") %>% 
  mutate(MID = ER30001*1000 + ER30002,FID = MID) %>%
  rename(earn97 = ER33536A,earn99 = ER33627A,earn01 = ER33727A) %>%
  rename(earn97u = ER33536B,earn99u = ER33627B,earn01u = ER33727B) %>%
  rename(wage97 = ER33537O,wage99 = ER33628O,wage01 = ER33728O) %>%
  rename(ww97 = ER33536C,ww99 = ER33627C,ww01 = ER33727C) %>%
  rename(hw97 = ER33536Q,hw99 = ER33627Q,hw01 = ER33727Q)
  
# let's just do these for now
D97 <- Dt2 %>% select(MID,FID,earn97,earn97u,wage97,ww97,hw97) %>%
  rename(earn=earn97,earnu=earn97u,wage=wage97,ww=ww97,hw=hw97) %>%
  mutate(year=1997)

D99 <- Dt2 %>% select(MID,FID,earn99,earn99u,wage99,ww99,hw99) %>%
  rename(earn=earn99,earnu=earn99u,wage=wage99,ww=ww99,hw=hw99) %>%
  mutate(year=1999)

D01 <- Dt2 %>% select(MID,FID,earn01,earn01u,wage01,ww01,hw01) %>%
  rename(earn=earn01,earnu=earn01u,wage=wage01,ww=ww01,hw=hw01) %>%
  mutate(year=2001)

#write.csv(T2,"~/Dropbox/PSID_CDS/T2clean.csv")

# --- Now, read in the T-2 in 2001 variables from the family file
Dt2 <- read.csv("~/Dropbox/PSID_CDS/PSID_RAW/T2_supp.csv") %>% 
  rename(intnum = ER21002,h_earn = ER23702F1,h_ww = ER23702D3,h_hw = ER23702E8) %>%
  rename(w_earn = ER23702L4, w_ww = ER23702J6, w_hw = ER23702L2) %>%
  mutate(year = 2003)

d01 <- read.csv("~/Dropbox/PSID_CDS/PSID_RAW/IndFileVertical.csv") %>% 
  filter(year==2003) %>% 
  mutate(X = NULL,MID = intnum68*1000 + pernum) %>%
  merge(Dt2) %>%
  mutate(year = 2001)

# D01 <- D01 %>% 
#   mutate(earn2 = case_when(sn==1 ~ h_earn,sn==2 ~ w_earn)) 

# D01 %>% filter(earn==0 & !is.na(earn2) & earn2>0) %>%
#   select(MID,FID,year,earn,earn2,sn)

D01 <- merge(D01,d01)
Ih = D01$sn==1
D01[Ih,c("earn","hw","ww")] = D01[Ih,c("h_earn","h_hw","h_ww")]
Iw = D01$sn==2
D01[Iw,c("earn","hw","ww")] = D01[Iw,c("w_earn","w_hw","w_ww")]
D01 <- select(D01,c("MID","FID","year","earn","earnu","wage","hw","ww"))

T2 <- rbind(D97,D99,D01) %>%
  mutate(earn = na_if(na_if(na_if(na_if(earn,-9999999),-999999),99999999),9999999)) %>%
  #mutate(earn = case_when(earnu==1 ~ earn*hw*ww,earnu==2 ~ earn*365,earnu==3 ~ earn*ww, earnu==4 ~ earn*ww/2,earnu==5 ~ earn*12, earnu==6 ~ earn, TRUE ~ NA_real_)) %>%
  mutate(ww = na_if(ww,99),hw=na_if(hw,999)) %>%
  mutate(hrs = ww*hw) %>%
  #mutate(wage2 = case_when(earn>0 & hrs>0 ~ earn/hrs,TRUE ~ NA_real_),0) %>%
  mutate(wage = case_when(wage<=0 ~ NA_real_,wage==999 ~ NA_real_,TRUE ~ wage)) %>%
  mutate(wage = case_when(earn>0 & is.na(wage) ~ earn/hrs, TRUE ~ wage))

write.csv(T2,"~/Dropbox/PSID_CDS/PSID_RAW/T2clean.csv")

```
This file links an individual to earnings and hours in non-survey years. Since our main panel is arranged in terms of mothers and fathers, we will rearrange the data into that format: 


```{r}
# we link first to mothers:
T2m <- D %>%
  select(MID) %>%
  unique() %>%
  inner_join(T2) %>% #<- first four lines pick out mothers in CDS sample
  rename(m_earn = earn,m_hrs = hrs) %>%
  mutate(m_wage = m_earn/m_hrs) %>%
  select(MID,year,m_earn,m_wage,m_hrs) #<- these are mothers so drop the FID variable

# and then to fathers
T2f <- D %>%
  select(FID) %>% 
  unique() %>%
  inner_join(T2) %>% #<-first four lines pick out "fathers" in sample (recall we are labelling all spouses as fathers)
  rename(f_earn = earn,f_hrs = hrs) %>%
  mutate(f_wage = f_earn/f_hrs) %>%
  select(FID,year,f_earn,f_wage,f_hrs) #<- these are fathers so drop the MID variable

# now we link the pair (MID,FID,year) first to mothers (MID,year) and then to fathers (MID,year), *then* we append all of this to the data from the main interview

```


## Merge in Labor Market Earnings, Hours, Wages


We finish by (1) linking each of these files to mothers and fathers in our panel sample; (2) Adding this to the data from the main interview; and (3) Merging with the panel dataset.

```{r}
D <- D %>%
  select(MID,FID,year) %>%
  inner_join(T2m) %>%
  left_join(T2f) %>%
  select(-FID) %>%
  rbind(L) %>% #<- add all of this to the original data frame with the interview year questions
  mutate(house_earn = case_when(!is.na(f_earn) ~ f_earn+m_earn,TRUE ~ m_earn),m_wage = na_if(na_if(m_wage,Inf),0),f_wage = na_if(na_if(f_wage,Inf),0)) %>%
  right_join(D) #%>%
```

We save the panel dataset.
```{r}
write.csv(D,"~/Dropbox/PSID_CDS/PSID_CLEAN/MotherPanelCDS.csv")
```


# Creating a Child Panel
It may be useful to link the above panel of data to our data on children. The chunk of code below arranges the CDS data into a combined panel and merges it with *MotherPanelCDS*. 

```{r}


# rename price of childcare in the childcare panel and save in dta format

ChildCarePanel <- read.csv("~/Dropbox/PSID_CDS/PSID_CLEAN/ChildCarePanel.csv")  %>% rename( p_chcare=Price) %>%select(-X)
write.dta(ChildCarePanel, "~/Dropbox/PSID_CDS/PSID_CLEAN/ChildCarePanel.dta")


#save active time panel in dta format
TD_agg <- read.csv("~/Dropbox/PSID_CDS/PSID_CLEAN/ActiveTimePanel.csv")%>%select(-X)
write.dta(TD_agg, "~/Dropbox/PSID_CDS/PSID_CLEAN/ActiveTimePanel.dta")

#construct measures of aggregate household expenditures on goods and save in dta format

#total household expenditures on goods: 
#hhinvest - basic category, 
#hhinvest_vc that includes basic expenditures, vacation and clothing, 
#hhexp_agg that includes all of the expenditures in the previous categories and food. 
Expenditures <- read.csv("~/Dropbox/PSID_CDS/PSID_CLEAN/Expenditures.csv") 
Expenditures<- Expenditures %>%  mutate(
                        hhinvest = SchSupplies+Toys+sports+lessons+tutoring+comm_grps, 
                        hhinvest_vc = hhinvest + Vacation + Clothing, 
                        hhexp_vcf=hhinvest_vc + Food) %>% select(-X)
summary(Expenditures$hhinvest)
write.dta(Expenditures, "~/Dropbox/PSID_CDS/PSID_CLEAN/HHExpend.dta")



cds <- read.csv("~/Dropbox/PSID_CDS/PSID_RAW/MotherIndex.csv") %>% mutate(X=NULL)

 
D_main <- C %>%
  group_by(KID) %>%
  filter(sum(CAH2==2)==0) %>% # drop children with adoption records
  rename(ybirth_child = CAH15) %>%
  mutate(ybirth_child = na_if(ybirth_child,9998)) %>%
  select(MID,KID,ybirth_child) %>%
  merge(D) %>%
  mutate(age = year - ybirth_child) %>%
  left_join(A) %>% #<- left_join assessments
  left_join(Expenditures) %>%
  left_join(ChildCarePanel) %>%
  left_join(TD_agg) %>%
  left_join(PPE)  %>%
  select(-starts_with("Q21"),-starts_with("ER"))
  

write.csv(D_main,"~/Dropbox/PSID_CDS/PSID_CLEAN/ChildPanelCDS.csv")
```

#Sample selection in mother's panel for the analysis in STATA

The code below does some basic data cleaning to mother's panel. 

```{r}


library(foreign)
#set children age to missing if parents report having no kids
#set negative wages and earnings for mother, fathers, and household to missing

sample_mother <- read.csv("~/Dropbox/PSID_CDS/PSID_CLEAN/MotherPanelCDS.csv")%>% mutate(
                              age_oldest = replace(age_oldest, which(num_child==0), NA),
                              age_youngest = replace(age_youngest, which(num_child==0), NA),
                              m_earn = replace(m_earn, which(m_earn<0), NA),
                              f_earn = replace(f_earn, which(f_earn<0), NA),
                              m_wage = replace(m_wage, which(m_wage<0), NA),
                              f_wage = replace(f_wage, which(f_wage<0), NA),
                              house_earn = replace(house_earn, which(house_earn<0), NA))



# replace TRUE/FALSE in marital status and ever married to an indicator variable
sample_mother$mar_stat [sample_mother$mar_stat == "TRUE"] <- 1
sample_mother$mar_stat [sample_mother$mar_stat == "FALSE"] <- 0
sample_mother$ever_married [sample_mother$ever_married == "TRUE"] <- 1
sample_mother$ever_married [sample_mother$ever_married == "FALSE"] <- 0

#generate race indicators
sample_mother<- sample_mother %>% mutate(
                                    m_white = ifelse(Race==1,1,0), 
                                    m_black=ifelse(Race==2,1,0), 
                                    m_r_oth=ifelse(Race>2,1,0))


table(sample_mother$Race , useNA="always")
table(sample_mother$m_r_oth, useNA="always")

#renaming some of the variables used in the analysis: 1) indicator variable for being currently married 2) age of mother 3) state fips code to 'state' for merging 4) annual childcare expenditures from main PSID survey 5) mother's standardized cognitive score

sample_mother <- sample_mother %>% rename( curr_married=mar_stat, m_age=age_mother,state_psid=state, state=StFIPS, chcare_ann=childcare_exp, m_pc97=m_pc_st)


#create indicator variables for parental educational categories: 

#hsd - high-school dropout; 
#hs - high schoold graduate; 
#scoll - some college; coll - college; 
#postcoll - postgraduate; 
#collplus - undergraduate and postgraduate degrees

#fathers educational categories
sample_mother <- sample_mother %>%mutate(
                            fed_hsd = ifelse(sample_mother$f_ed== "<12",1,0),
                            fed_hs = ifelse(sample_mother$f_ed== "12",1,0),
                            fed_scoll = ifelse(sample_mother$f_ed== "13-15",1,0),
                            fed_coll = ifelse(sample_mother$f_ed== "16",1,0),
                            fed_postcol = ifelse(sample_mother$f_ed== ">16",1,0),
                            fed_collplus = fed_coll+fed_postcol)



table(sample_mother$f_ed, useNA = "always")
table(sample_mother$fed_hsd, useNA = "always")
table(sample_mother$fed_hs, useNA = "always")
table(sample_mother$fed_collplus, useNA = "always")

#mothers educational categories
sample_mother <- sample_mother %>%mutate(
                              med_hsd = ifelse(sample_mother$m_ed== "<12",1,0),
                              med_hs = ifelse(sample_mother$m_ed== "12",1,0),
                              med_scoll = ifelse(sample_mother$m_ed== "13-15",1,0),
                              med_coll = ifelse(sample_mother$m_ed== "16",1,0),
                              med_postcol  = ifelse(sample_mother$m_ed== ">16",1,0),
                              med_collplus = med_coll+med_postcol)

table(sample_mother$m_ed, useNA = "always")
table(sample_mother$med_hsd, useNA = "always")
table(sample_mother$med_collplus, useNA = "always")


# create variables describing age composition of children
sample_mother <- sample_mother %>% mutate(
                          age_gap = age_oldest-age_youngest,
                          age0to5only = ifelse(age_oldest<=5,1,0),  
                          age5to10only = ifelse(age_oldest<=10&age_youngest>=5,1,0),
                          age0to10only = ifelse(age_oldest<=10,1,0),
                          age0to12only = ifelse(age_oldest<=12,1,0),
                          age5to12only = ifelse(age_oldest<=12&age_youngest>=5,1,0),
                          age6to12only = ifelse(age_oldest<=12&age_youngest>=6,1,0))

#generate variables that wil be used in the sample selection
# mother's  age at birth of the oldest child - momageatbirth1
# number of children younger than 12 - num_0_12
sample_mother <- sample_mother %>% mutate(
                                        #generate a variable measuring number of children younger than 12
                                        num_0_12=num_0_5+num_6_12,
                                        #mom age at oldest child's birth
                                        momageatbirth1 = m_age - age_oldest)

# create measures of potential work experience
sample_mother <- sample_mother %>%mutate(
m_exper = case_when(sample_mother$med_scoll==1~m_age-20,sample_mother$med_scoll==1~m_age-22, sample_mother$med_postcol==1~m_age-24, TRUE ~ m_age -18),
f_exper = case_when(sample_mother$fed_scoll==1~f_age-20,sample_mother$fed_scoll==1~f_age-22, sample_mother$fed_postcol==1~f_age-24, TRUE ~ f_age -18),
m_exper2=m_exper*m_exper,
f_exper2=f_exper*f_exper)

# Create positive wages and hours indicators
sample_mother <- sample_mother %>% mutate(#childcare expenditures from CDS
                                        #wage, earnings, and hours by mother and father
                                        pos_wage_m = ifelse(m_wage>0 & !is.na(m_wage), 1,0),
                                        pos_wage_m = ifelse(is.na(m_wage), NA,pos_wage_m),
                                        pos_wage_f = ifelse(f_wage>0 & !is.na(f_wage), 1,0),
                                        pos_wage_f =ifelse(is.na(f_wage), NA,pos_wage_f),
                                        
                                        pos_earn_m = ifelse(m_earn>0 & !is.na(m_earn), 1,0),
                                        pos_earn_m = ifelse(is.na(m_earn), NA,pos_earn_m),
                                        pos_earn_f = ifelse(f_earn>0 & !is.na(f_earn), 1,0),
                                        pos_earn_f = ifelse(is.na(f_earn), NA,pos_earn_f),     
                                        
                                        pos_hrs_m = ifelse(m_hrs>0 & !is.na(m_hrs), 1,0),
                                        pos_hrs_m= ifelse(is.na(m_hrs), NA,pos_hrs_m),
                                        pos_hrs_f = ifelse(f_hrs>0 & !is.na(f_hrs), 1,0),
                                        pos_hrs_f=ifelse(is.na(f_hrs), NA,pos_hrs_f),
                                        #replace wage and earnings to missing if hours are missing
                                        pos_wage_m= ifelse(is.na(m_hrs), NA,pos_wage_m),
                                        pos_wage_f= ifelse(is.na(f_hrs), NA,pos_wage_f),
                                        pos_earn_m= ifelse(is.na(m_hrs), NA,pos_earn_m),
                                        pos_earn_f= ifelse(is.na(f_hrs), NA,pos_earn_f),
                                        pos_hrs_mf =pos_hrs_m*pos_hrs_f)
names(sample_mother)<- tolower(names(sample_mother))

# Generate log wage measures and log relative wage
sample_mother <- sample_mother %>% mutate(
                                        ln_wage_m=log(m_wage),
                                        ln_wage_f=log(f_wage),
                                        ln_wage_fm_ratio = ln_wage_f - ln_wage_m)


#saving the dataset to dta format
write.dta(sample_mother, "~/Dropbox/PSID_CDS/PSID_CLEAN/MotherPanelCDS.dta")

```
#Sample selection in mother's panel for the analysis in STATA
The code below introduces sample restrictions to be used in the estimation of fixed effects for mother's and father's wage:
- 1985<= Year <=2002
- Parents ages 18-65 during survey year
- Mothers were ages 16-45 at birth of the oldest child
- Reported state

```{r}
#Sample restriction:year
wagedat_tmp <- sample_mother[sample_mother$year<=2002&sample_mother$year>=1985,]

#Sample restriction:restrict to  mothers ages 16-45 when the oldest child was born
wagedat_tmp <-wagedat_tmp [(wagedat_tmp$momageatbirth1>=16&wagedat_tmp$momageatbirth1<=45)|is.na(wagedat_tmp$momageatbirth1),]

#Sample restriction:restrict to working age parents
wagedat_tmp <- wagedat_tmp[(wagedat_tmp$m_age>=18&wagedat_tmp$m_age<=65)|is.na(wagedat_tmp$m_age),]
wagedat_tmp <- wagedat_tmp[(wagedat_tmp$f_age>=18&wagedat_tmp$f_age<=65)|is.na(wagedat_tmp$f_age),]

wagedat_tmp <- wagedat_tmp[!is.na(wagedat_tmp$state),]


#Trim top/bottom 1% of wages by year

# Quantiles
q_m <- do.call("rbind",
        tapply(wagedat_tmp$m_wage,       # Specify numeric column
               wagedat_tmp$year,            # Specify group variable
               quantile, probs = c(1, 99)/100, na.rm = TRUE))
q_f <- do.call("rbind",
        tapply(wagedat_tmp$f_wage,       # Specify numeric column
               wagedat_tmp$year,            # Specify group variable
               quantile, probs = c(1, 99)/100, na.rm = TRUE))
summary(wagedat_tmp$m_wage)
summary(wagedat_tmp$f_wage)

years <- c(seq(1985,2002))
for (i in 1:length(years)) {
 wagedat_tmp <- wagedat_tmp %>% mutate(m_wage = ifelse((m_wage<q_m[i,1]|m_wage>q_m[i,2])&year==years[i],NA,m_wage),
                                    f_wage = ifelse((f_wage<q_f[i,1]|f_wage>q_f[i,2])&year==years[i],NA,f_wage)) 
}

# Recalculate log wage measures and log relative wage for trimmed wages
sample_mother <- sample_mother %>% mutate(
                                        ln_wage_m=log(m_wage),
                                        ln_wage_f=log(f_wage),
                                        ln_wage_fm_ratio = ln_wage_f - ln_wage_m)        
                                    
summary(wagedat_tmp$m_wage)
summary(wagedat_tmp$f_wage)
#saving the dataset to dta format
write.dta(wagedat_tmp, "~/Dropbox/PSID_CDS/PSID_CLEAN/wagedat_tmp.dta")

```


#Data cleaning in child's panel for the analysis in STATA
The code below does some basic data cleaning to child's panel and limits the sample to HH with children age 0-18.

```{r}


sample_child <- read.csv("~/Dropbox/PSID_CDS/PSID_CLEAN/ChildPanelCDS.csv")%>% mutate(
                              age_oldest = replace(age_oldest, which(num_child==0), NA),
                              age_youngest = replace(age_youngest, which(num_child==0), NA),
                              m_earn = replace(m_earn, which(m_earn<0), NA),
                              f_earn = replace(f_earn, which(f_earn<0), NA),
                              m_wage = replace(m_wage, which(m_wage<0), NA),
                              f_wage = replace(f_wage, which(f_wage<0), NA),
                              house_earn = replace(house_earn, which(house_earn<0), NA))



# replace TRUE/FALSE in marital status and ever married to an indicator variable
sample_child$mar_stat [sample_child$mar_stat == "TRUE"] <- 1
sample_child$mar_stat [sample_child$mar_stat == "FALSE"] <- 0
sample_child$ever_married [sample_child$ever_married == "TRUE"] <- 1
sample_child$ever_married [sample_child$ever_married == "FALSE"] <- 0

#generate race indicators
sample_child <- sample_child %>% mutate(
                                m_white= ifelse(Race==1,1,0), 
                                m_black=ifelse(Race==2,1,0), 
                                m_r_oth=ifelse(Race>2,1,0))



#renaming some of the variables used in the analysis: 1) indicator variable for being currently married 2) age of mother 3) state fips code to 'state' for merging 4) annual childcare expenditures from main PSID survey 5) mother's standardized cognitive score

sample_child <- sample_child %>% rename( curr_married=mar_stat, m_age=age_mother, state_psid=state, state=StFIPS, chcare_ann=childcare_exp, m_pc97=m_pc_st)

# gnerate a measure for weekly childcare expenditure based on the annual childcare expenditure report from main PSID
sample_child <- sample_child %>%  mutate(chcare_hh = chcare_ann/52)



#create indicator variables for parental educational categories: 
#hsd - high-school dropout; hs - high schoold graduate; scoll - some college; coll - college; postcoll - postgraduate; collplus - undergraduate and postgraduate degrees
#fathers educational categories
sample_child <- sample_child %>%mutate(
                              fed_hsd= ifelse(sample_child$f_ed== "<12",1,0),
                              fed_hs= ifelse(sample_child$f_ed== "12",1,0),
                              fed_scoll= ifelse(sample_child$f_ed== "13-15",1,0),
                              fed_coll= ifelse(sample_child$f_ed== "16",1,0),
                              fed_postcol= ifelse(sample_child$f_ed== ">16",1,0),
                              fed_collplus = fed_coll+fed_postcol)


table(sample_child$f_ed, useNA = "always")
table(sample_child$fed_hsd, useNA = "always")


#mothers educational categories
sample_child <- sample_child %>%mutate(
                                med_hsd= ifelse(sample_child$m_ed== "<12",1,0),
                                med_hs= ifelse(sample_child$m_ed== "12",1,0), 
                                med_scoll= ifelse(sample_child$m_ed== "13-15",1,0),
                                med_coll= ifelse(sample_child$m_ed== "16",1,0),
                                med_postcol= ifelse(sample_child$m_ed== ">16",1,0),
                                med_collplus = med_coll+med_postcol)

table(sample_child$m_ed, useNA = "always")
table(sample_child$med_hsd, useNA = "always")


# create a variable: mother's age at birth, age at birth of the oldest child, number of children younger than 12 
sample_child <- sample_child %>% mutate(momageatbirth = m_age - age,
                                        num_0_12=num_0_5+num_6_12,
                                        #mom age at oldest child's birth
                                        momageatbirth1 = m_age - age_oldest)


# create variables describing age composition of children

sample_child <- sample_child %>% mutate(
                                        age_gap= age_oldest-age_youngest,
                                        age_rel_to_y = age-age_youngest,
                                        age_rel_to_o = age-age_oldest,
                                        age0to5only= ifelse(age_oldest<=5,1,0),  
                                        age5to10only= ifelse(age_oldest<=10&age_youngest>=5,1,0),
                                        age0to10only= ifelse(age_oldest<=10,1,0),
                                        age0to12only= ifelse(age_oldest<=12,1,0),
                                        age5to12only= ifelse(age_oldest<=12&age_youngest>=5,1,0),
                                        age6to12only= ifelse(age_oldest<=12&age_youngest>=6,1,0),
                                        very_young= ifelse(age<=2,1,0))


names(sample_child)<- tolower(names(sample_child))
# Generate an indicator for some non-missing CDS investment measure
sample_child$CDS_invest_ind = with(sample_child, ifelse(is.na(tau_m)&is.na(tau_f)&is.na(chcare)& is.na(hhinvest), 0,1))
 
#Sample restriction:keep only children aged 0-18, HH with children
sample_child <- sample_child[sample_child$age>=0&sample_child$age<=18&sample_child$num_child>0,]


write.dta(sample_child, "~/Dropbox/PSID_CDS/PSID_CLEAN/CDSMainPanel.dta")


# import state-year average wage measures constructed from CPS "wages_cps.dta" from dta to csv and merge with the child's panel
library(haven)
wages_cps <- read_dta("~/Dropbox/PSID_CDS/PSID_CLEAN/wages_cps.dta")
psid_child <- sample_child %>%left_join(wages_cps)

#Import state-year childcare price data from dta to csv and merge with the child's panel
p_extendedcosts <- read_dta("~/Dropbox/PSID_CDS/PSID_CLEAN/p_extendedcosts.dta")%>%rename(state = stateid, p_all=all, p_goods=goods, p_serv=servo)
psid_child <- psid_child %>%left_join(p_extendedcosts)
#Import region and district dummies and merge with child data
crosswalk_state_reg_div <- read_dta("~/Dropbox/PSID_CDS/PSID_CLEAN/crosswalk_state_reg_div.dta")%>%rename(region_name=region, division_name=division, state_name=state, state=fipcode, region=regioncode, division=divisioncode )
psid_child <- psid_child %>%left_join(crosswalk_state_reg_div)


#Create a weighted average HH investment price measure
psid_child <- psid_child %>%  mutate(p_avg = 0.3*p_serv + .7*p_goods)


# Create positive investment input and wages indicators

psid_child <- psid_child %>% mutate(#childcare expenditures from CDS
                                        pos_chcare = ifelse(chcare>0 & !is.na(chcare), 1,0),
                                        pos_chcare = ifelse(is.na(chcare), NA,pos_chcare),
                                        #annual childcare expenditures from main PSID
                                        pos_chcare_hh = ifelse(chcare_hh>0 & !is.na(chcare_hh), 1,0),
                                        pos_chcare_hh = ifelse(is.na(chcare_hh), NA,pos_chcare_hh),
                                        #household goods expenditures
                                        pos_hhinvest = ifelse(hhinvest>0 & !is.na(hhinvest), 1,0),
                                        pos_hhinvest = ifelse(is.na(hhinvest), NA,pos_hhinvest),
                                        # total time by mother and father
                                        pos_tau_m = ifelse(tau_m>0 & !is.na(tau_m), 1,0),
                                        pos_tau_m = ifelse(is.na(tau_m), NA,pos_tau_m),
                                        pos_tau_f = ifelse(tau_f>0 & !is.na(tau_f), 1,0),
                                        pos_tau_f = ifelse(is.na(tau_f), NA,pos_tau_f),
                                        #wage, earnings, and hours by mother and father
                                        pos_wage_m = ifelse(m_wage>0 & !is.na(m_wage), 1,0),
                                        pos_wage_m = ifelse(is.na(m_wage), NA,pos_wage_m),
                                        pos_wage_f = ifelse(f_wage>0 & !is.na(f_wage), 1,0),
                                        pos_wage_f =ifelse(is.na(f_wage), NA,pos_wage_f),
                                        
                                        pos_earn_m = ifelse(m_earn>0 & !is.na(m_earn), 1,0),
                                        pos_earn_m = ifelse(is.na(m_earn), NA,pos_earn_m),
                                        pos_earn_f = ifelse(f_earn>0 & !is.na(f_earn), 1,0),
                                        pos_earn_f = ifelse(is.na(f_earn), NA,pos_earn_f),     
                                        
                                        pos_hrs_m = ifelse(m_hrs>0 & !is.na(m_hrs), 1,0),
                                        pos_hrs_m= ifelse(is.na(m_hrs), NA,pos_hrs_m),
                                        pos_hrs_f = ifelse(f_hrs>0 & !is.na(f_hrs), 1,0),
                                        pos_hrs_f=ifelse(is.na(f_hrs), NA,pos_hrs_f),
                                        #replace wage and earnings to missing if hours are missing
                                        pos_wage_m= ifelse(is.na(m_hrs), NA,pos_wage_m),
                                        pos_wage_f= ifelse(is.na(f_hrs), NA,pos_wage_f),
                                        pos_earn_m= ifelse(is.na(m_hrs), NA,pos_earn_m),
                                        pos_earn_f= ifelse(is.na(f_hrs), NA,pos_earn_f),
                                        pos_hrs_mf =pos_hrs_m*pos_hrs_f)

#calculate childcare expenditure per child based on main PSID report and use it to impute childcare expenditures when they are not reported in CDS

psid_child <- psid_child %>% mutate(
                                  #weekly measure of HH expenditures on childcare per kid ages 0-12 (avail 2002) 
                                 chcare_hh_pc = chcare_hh/num_0_12, 
                                 chcare_imp = ifelse(is.na(chcare),chcare_hh_pc, chcare),
                                 #indicator for positive reports
                                 pos_chcare_imp = ifelse(chcare_imp>0 & !is.na(chcare_imp), 1,0),
                                 pos_chcare_imp = ifelse(is.na(chcare_imp), NA,pos_chcare_imp))



#Generate log input measures, keep log investment:
#time - if between 0.25 and 100 weekly hours
#HH expenditures on goods - higher than $1 per week
#measures of childcare expenditures- between $1 and $1000 dollars per week
psid_child <- psid_child %>% mutate(
                                 ln_tau_m = log(tau_m),  
                                 ln_tau_f = log(tau_f),
                                 ln_hhinvest = log(hhinvest),
                                 ln_chcare = log(chcare),
                                 ln_chcare_hh_pc=log(chcare_hh_pc),
                                 
                                 ln_tau_m=ifelse(tau_m<0.25|tau_m>100, NA, ln_tau_m),
                                 ln_tau_f=ifelse(tau_f<0.25|tau_f>100, NA, ln_tau_f),
                                 ln_hhinvest=ifelse(hhinvest<1, NA, ln_hhinvest),
                                 ln_chcare=ifelse(chcare<1|chcare>1000, NA,ln_chcare),
                                 ln_chcare_hh_pc=ifelse(chcare_hh_pc<1|chcare_hh_pc>1000, NA,ln_chcare_hh_pc),
                                 ln_chcare_imp = ifelse(is.na(ln_chcare),ln_chcare_hh_pc, ln_chcare)
                                 )



 #Sample restriction:keep only 1997 and 2007 due to the availability of investment information
psid_child <- psid_child[psid_child$year==1997|psid_child$year==2002,]


write.dta(psid_child, "~/Dropbox/PSID_CDS/PSID_CLEAN/psid_child.dta")




```
#Sample selection in child's panel for the analysis in STATA
The code below introduces sample restrictions to be used in the relative demand for inputs estimation:

- Parents ages 18-65 during survey year
- Mothers were ages 16-45 during year of child’s birth
- Child-year observations for children ages 12 and under
- Child-year observations for households with only 1 or 2 children ages 12 of younger (can have older children)

It then calculates the relative inputs and relative input prices ratios. 

```{r}


# Introduce sample selection rules for the child sample psid_child.dta

#Sample restriction:restrict to sample mothers ages 16-45 when child was born
psid_child <-psid_child[(psid_child$momageatbirth>=16&psid_child$momageatbirth<=45)|is.na(psid_child$momageatbirth),]

#Sample restriction:restrict to working age parents
psid_child <- psid_child[(psid_child$m_age>=18&psid_child$m_age<=65)|is.na(psid_child$m_age),]
psid_child <- psid_child[(psid_child$f_age>=18&psid_child$f_age<=65)|is.na(psid_child$f_age),]

#Sample restriction:restrict to those with some measure of investment in CDS_invest_ind
psid_child <- psid_child[psid_child$CDS_invest_ind==1,]

summary(psid_child$ln_P4ca_Wm_ratio)

#Trim top/bottom 1% of wages by year
# Quantiles
q_m <- do.call("rbind",
        tapply(psid_child$m_wage,       # Specify numeric column
               psid_child$year,            # Specify group variable
               quantile, probs = c(1, 99)/100, na.rm = TRUE))
q_f <- do.call("rbind",
        tapply(psid_child$f_wage,       # Specify numeric column
               psid_child$year,            # Specify group variable
               quantile, probs = c(1, 99)/100, na.rm = TRUE))
summary(psid_child$m_wage)
summary(psid_child$f_wage)

# Samples between quantiles
psid_child <- psid_child %>% mutate(m_wage = ifelse((m_wage<q_m[1,1]|m_wage>q_m[1,2])&year==1997,NA,m_wage),
                                    m_wage = ifelse((m_wage<q_m[2,1]|m_wage>q_m[2,2])&year==2002,NA,m_wage),
                                    f_wage = ifelse((f_wage<q_f[1,1]|f_wage>q_f[1,2])&year==1997,NA,f_wage),
                                    f_wage = ifelse((f_wage<q_f[2,1]|f_wage>q_f[2,2])&year==2002,NA,f_wage)             
                                    )

#Calculate log wages, and relative log wages between mother and father for trimmed wages
psid_child <- psid_child %>% mutate(
                                 ln_wage_m  = log(m_wage),  
                                 ln_wage_f = log(f_wage),
                                 ln_wage_fm_ratio = ln_wage_f - ln_wage_m)



# Calculate investments, investment expenditures 
psid_child <- psid_child %>% mutate(
                                  #joint time with father and mother for two-parent HH
                                 tau_mf= case_when(curr_married==1~tau_m+tau_f,TRUE~tau_m ), 
                                 #time expenditure for mother and father, joint
                                 tau_m_exp=m_wage*tau_m,
                                 tau_f_exp=f_wage*tau_f,
                                 tau_mf_exp= case_when(curr_married==1~tau_m_exp+tau_f_exp,TRUE~tau_m_exp))





#Create log relative input price ratios (scale childcare costs from annual into hourly units assuming average full-time care is 33hrs/week x 52 weeks))
psid_child <- psid_child %>% mutate(
                                 ln_pratio_4ca = log(p_yocent_e_cps_cpkt) - log(p_avg) - log(33*52),
                                 ln_pratio_ica = log(p_icent_e_cps_cpkt)  - log(p_avg) - log(33*52),
                                 ln_pratio_4fa = log(p_yofcc_e_cps_cpkt)  - log(p_avg)  - log(33*52),
                                 ln_pratio_ifa = log(p_ifcc_e_cps_cpkt)   - log(p_avg) - log(33*52),
                                 ln_wage_m_rel = ln_wage_m - log(p_avg),
                                 ln_wage_f_rel = ln_wage_f - log(p_avg),
                                 ln_P4ca_Wm_ratio = log(p_yocent_e_cps_cpkt) - ln_wage_m - log(33*52),
                                 ln_Pica_Wm_ratio = log(p_icent_e_cps_cpkt)  - ln_wage_m - log(33*52),
                                 ln_P4fa_Wm_ratio = log(p_yofcc_e_cps_cpkt)  - ln_wage_m - log(33*52),
                                 ln_Pifa_Wm_ratio = log(p_ifcc_e_cps_cpkt)   - ln_wage_m - log(33*52),
                                 ln_P4ca_Wf_ratio = log(p_yocent_e_cps_cpkt) - ln_wage_f - log(33*52),
                                 ln_Pica_Wf_ratio = log(p_icent_e_cps_cpkt)  - ln_wage_f - log(33*52),
                                 ln_P4fa_Wf_ratio = log(p_yofcc_e_cps_cpkt)  - ln_wage_f - log(33*52),
                                 ln_Pifa_Wf_ratio = log(p_ifcc_e_cps_cpkt)   - ln_wage_f - log(33*52))
                          

 #create log input and input expenditure ratios   
psid_child <- psid_child %>% mutate(
                               #ln(tau_f/tau_m)
                               ln_tau_fm_ratio = ln_tau_f - ln_tau_m ,
                               #ln(W_f tau_f/ (W_m tau_m))
                               ln_tau_fm_exp_ratio = ln_tau_f + ln_wage_f - ln_tau_m - ln_wage_m ,
                               #mother ln(tau/g)
                               ln_tau_m_g_ratio = ln_tau_m - ln_hhinvest + log(p_avg) ,
                               #father ln(tau/g)
                               ln_tau_f_g_ratio = ln_tau_f - ln_hhinvest + log(p_avg) ,
                               #mother ln(W*tau/(p*g))
                               ln_tau_m_g_exp_ratio = ln_tau_m + ln_wage_m  - ln_hhinvest  , 
                               #father ln(W*tau/(p*g))
                               ln_tau_f_g_exp_ratio = ln_tau_f + ln_wage_f - ln_hhinvest ,
                               #ln(PY/(p*g)) -- child-specific measure
                               ln_invratio       = ln_chcare - ln_hhinvest ,
                               #ln(PY/(p*g)) -- per capita HH measure
                               ln_invratio_hh_pc = ln_chcare_hh_pc - ln_hhinvest,
                               #ln(PY/(p*g)) -- imputed measure from child-specific & per capita HH measures
                               ln_invratio_imp   = ln_chcare_imp - ln_hhinvest,   
                               #mother ln(Y*P/W*tau)
                               ln_YP_tauW_m  = ln_chcare_imp - (ln_tau_m + ln_wage_m),
                               #father ln(Y*P/W*tau)
                               ln_YP_tauW_f  = ln_chcare_imp - (ln_tau_f + ln_wage_f)  
                             )
 
 #Create person-specific measures of avg wages from CPS (to be used as instruments)

 # difference in male-fem avg log wages by state-year & educ for ages 30-39  (matches with father/mother)
 psid_child <- psid_child %>% mutate(
                               Dln_avgwage_hs_30    = lnhwage_m_hs_30 - lnhwage_f_hs_30,            # HS grads
                               Dln_avgwage_scoll_30 = lnhwage_m_scoll_30 - lnhwage_f_scoll_30,      # some coll
                               Dln_avgwage_coll_30  = lnhwage_m_coll_30 - lnhwage_f_coll_30,        # coll grads
                                
                              #make mother/father education-specific predicted wages (uses HS wages for HS dropouts and grads) based on age 
                              # note m refers to mother in psid but the m refers to male for avg wages in CPS
                              
                               m_ln_avgwage_30 = case_when((med_hsd==1|med_hs==1) ~ lnhwage_f_hs_30, med_scoll==1 ~ lnhwage_f_scoll_30 , med_collplus==1~ lnhwage_f_coll_30, TRUE~NA_real_),  
                              
                               f_ln_avgwage_30 = case_when((fed_hsd==1|fed_hs==1) ~ lnhwage_m_hs_30, fed_scoll==1 ~ lnhwage_m_scoll_30 , fed_collplus==1~ lnhwage_m_coll_30, TRUE~NA_real_), 
                              # rescale mother- or father-specific measures by average HH investment input prices
                              
                                m_ln_avgwage_30 = m_ln_avgwage_30 - log(p_avg),
                                f_ln_avgwage_30 = f_ln_avgwage_30 - log(p_avg),
                              #make education-specific avg father/mother predicted log wage ratio by age (use HS wages for HS dropouts and grads)
                              
                               Dln_avgwage_30 = f_ln_avgwage_30 - m_ln_avgwage_30
                              )


 # difference in male-fem avg log wages by state-year & educ for ages 40-49  (matches with father/mother)
 psid_child <- psid_child %>% mutate(
                               Dln_avgwage_hs_40    = lnhwage_m_hs_40 - lnhwage_f_hs_40,            # HS grads
                               Dln_avgwage_scoll_40 = lnhwage_m_scoll_40 - lnhwage_f_scoll_40,      # some coll
                               Dln_avgwage_coll_40  = lnhwage_m_coll_40 - lnhwage_f_coll_40,        # coll grads
                                
                              #make mother/father education-specific predicted wages (uses HS wages for HS dropouts and grads) based on age 
                              # note m refers to mother in psid but the m refers to male for avg wages in CPS
                              
                               m_ln_avgwage_40 = case_when((med_hsd==1|med_hs==1) ~ lnhwage_f_hs_40, med_scoll==1 ~ lnhwage_f_scoll_40 , med_collplus==1~ lnhwage_f_coll_40, TRUE~NA_real_),         
                              
                               f_ln_avgwage_40 = case_when((fed_hsd==1|fed_hs==1) ~ lnhwage_m_hs_40, fed_scoll==1 ~ lnhwage_m_scoll_40 , fed_collplus==1~ lnhwage_m_coll_40, TRUE~NA_real_),                    
                              # rescale mother- or father-specific measures by average HH investment input prices
                              
                                m_ln_avgwage_40 = m_ln_avgwage_40 - log(p_avg),
                               f_ln_avgwage_40 = f_ln_avgwage_40 - log(p_avg),
                              #make education-specific avg father/mother predicted log wage ratio by age (use HS wages for HS dropouts and grads)
                              
                               Dln_avgwage_40 = f_ln_avgwage_40 - m_ln_avgwage_40
                              )
 
 
#make age- and education-specific avg. father/mother predicted log wage ratio (use HS wages for HS dropouts and grads)
#note that the components f_ln_avgwage_* have already been scaled by average HH investment input prices (do not need to rescale again!)

 psid_child <- psid_child %>% mutate(
                       f_ln_avgwage=case_when(f_age>=40 ~ f_ln_avgwage_40, f_age<40 ~ f_ln_avgwage_30, TRUE~NA_real_),
                       m_ln_avgwage=case_when(m_age>=40 ~ m_ln_avgwage_40, m_age<40 ~ m_ln_avgwage_30, TRUE~NA_real_),
                       Dln_avgwage = f_ln_avgwage - m_ln_avgwage)
 
summary(psid_child$m_wage)
summary(psid_child$f_wage)

write.dta(psid_child, "~/Dropbox/PSID_CDS/PSID_CLEAN/psid_fam.dta")


#Sample restriction: keep only families with only 1 or 2 children ages<=12, child<=12
psid_child <- psid_child[psid_child$age<=12&psid_child$num_0_12<=2,]

write.dta(psid_child, "~/Dropbox/PSID_CDS/PSID_CLEAN/psid_fam_young.dta")


```
