---
title: "Sample selection"
output: html_document
date: '2022-11-16'
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

Sample selection in mother's panel for the analysis in STATA

The code below does some basic data cleaning to mother's panel. 

```{r}
library(dplyr)
library(tidyr)
library(foreign)

sample_mother <- read.csv("~/Dropbox/PSID_CDS/PSID_CLEAN/MotherPanelCDS.csv") 

#set children age to missing if parents report having no kids
#set negative wages and earnings for mother, fathers, and household to missing


sample_mother <- sample_mother %>% mutate(
                              age_oldest = replace(age_oldest, which(num_child==0), NA),
                              age_youngest = replace(age_youngest, which(num_child==0), NA),
                              m_earn = replace(m_earn, which(m_earn<0), NA),
                              f_earn = replace(f_earn, which(f_earn<0), NA),
                              m_wage = replace(m_wage, which(m_wage<0), NA),
                              f_wage = replace(f_wage, which(f_wage<0), NA),
                              house_earn = replace(house_earn, which(house_earn<0), NA))


# replace TRUE/FALSE in marital status and ever married to an indicator variable
sample_mother$mar_stat [sample_mother$mar_stat == "TRUE"] <- 1
sample_mother$mar_stat [sample_mother$mar_stat == "FALSE"] <- 0
sample_mother$ever_married [sample_mother$ever_married == "TRUE"] <- 1
sample_mother$ever_married [sample_mother$ever_married == "FALSE"] <- 0

#generate race indicators
sample_mother<- sample_mother %>% mutate(
                                    m_white = ifelse(Race==1,1,0), 
                                    m_black=ifelse(Race==2,1,0), 
                                    m_r_oth=ifelse(Race>2,1,0))


table(sample_mother$Race , useNA="always")
table(sample_mother$m_r_oth, useNA="always")

#renaming some of the variables used in the analysis: 1) indicator variable for being currently married 2) age of mother 3) state fips code to 'state' for merging 4) annual childcare expenditures from main PSID survey 5) mother's standardized cognitive score

sample_mother <- sample_mother %>% rename( curr_married=mar_stat, m_age=age_mother,state_psid=state, state=StFIPS, chcare_ann=childcare_exp, m_pc97=m_pc_st)



#create indicator variables for parental educational categories: 

#hsd - high-school dropout; 
#hs - high schoold graduate; 
#scoll - some college; coll - college; 
#postcoll - postgraduate; 
#collplus - undergraduate and postgraduate degrees

#fathers educational categories
sample_mother <- sample_mother %>%mutate(
                            fed_hsd = ifelse(sample_mother$f_ed== "<12",1,0),
                            fed_hs = ifelse(sample_mother$f_ed== "12",1,0),
                            fed_scoll = ifelse(sample_mother$f_ed== "13-15",1,0),
                            fed_coll = ifelse(sample_mother$f_ed== "16",1,0),
                            fed_postcol = ifelse(sample_mother$f_ed== ">16",1,0),
                            fed_collplus = fed_coll+fed_postcol)



table(sample_mother$f_ed, useNA = "always")
table(sample_mother$fed_hsd, useNA = "always")
table(sample_mother$fed_hs, useNA = "always")
table(sample_mother$fed_collplus, useNA = "always")

#mothers educational categories
sample_mother <- sample_mother %>%mutate(
                              med_hsd = ifelse(sample_mother$m_ed== "<12",1,0),
                              med_hs = ifelse(sample_mother$m_ed== "12",1,0),
                              med_scoll = ifelse(sample_mother$m_ed== "13-15",1,0),
                              med_coll = ifelse(sample_mother$m_ed== "16",1,0),
                              med_postcol  = ifelse(sample_mother$m_ed== ">16",1,0),
                              med_collplus = med_coll+med_postcol)

table(sample_mother$m_ed, useNA = "always")
table(sample_mother$med_hsd, useNA = "always")
table(sample_mother$med_collplus, useNA = "always")


# create variables describing age composition of children
sample_mother <- sample_mother %>% mutate(
                          age_gap = age_oldest-age_youngest,
                          age0to5only = ifelse(age_oldest<=5,1,0),  
                          age5to10only = ifelse(age_oldest<=10&age_youngest>=5,1,0),
                          age0to10only = ifelse(age_oldest<=10,1,0),
                          age0to12only = ifelse(age_oldest<=12,1,0),
                          age5to12only = ifelse(age_oldest<=12&age_youngest>=5,1,0),
                          age6to12only = ifelse(age_oldest<=12&age_youngest>=6,1,0))

#generate variables that wil be used in the sample selection
# mother's  age at birth of the oldest child - momageatbirth1
# number of children younger than 12 - num_0_12
sample_mother <- sample_mother %>% mutate(
                                        #generate a variable measuring number of children younger than 12
                                        num_0_12=num_0_5+num_6_12,
                                        #mom age at oldest child's birth
                                        momageatbirth1 = m_age - age_oldest)





# create measures of potential work experience
sample_mother <- sample_mother %>%mutate(
m_exper = case_when(sample_mother$med_scoll==1~m_age-20,sample_mother$med_scoll==1~m_age-22, sample_mother$med_postcol==1~m_age-24, TRUE ~ m_age -18),
f_exper = case_when(sample_mother$fed_scoll==1~f_age-20,sample_mother$fed_scoll==1~f_age-22, sample_mother$fed_postcol==1~f_age-24, TRUE ~ f_age -18),
m_exper2=m_exper*m_exper,
f_exper2=f_exper*f_exper)

names(sample_mother)<- tolower(names(sample_mother))


#saving the dataset to dta format
write.dta(sample_mother, "~/Desktop/PSID_CDS/PSID_CLEAN/MotherPanelCDS_R.dta")

```
#Sample selection in mother's panel for the analysis in STATA
The code below introduces sample restrictions to be used in the estimation of fixed effects for mother's and father's wage:
- 1985<= Year <=2002
- Parents ages 18-65 during survey year
- Mothers were ages 16-45 at birth of the oldest child
- Reported state

```{r}
#Sample restriction: years 1985-2002
wagedat_tmp <- sample_mother[sample_mother$year<=2002&sample_mother$year>=1985,]

#Sample restriction:restrict to  mothers ages 16-45 when the oldest child was born
wagedat_tmp <-wagedat_tmp [(wagedat_tmp$momageatbirth1>=16&wagedat_tmp$momageatbirth1<=45)|is.na(wagedat_tmp$momageatbirth1)==1,]

#Sample restriction:restrict to working age parents
wagedat_tmp <- wagedat_tmp[(wagedat_tmp$m_age>=18&wagedat_tmp$m_age<=65)|is.na(wagedat_tmp$m_age)==1,]
wagedat_tmp <- wagedat_tmp[(wagedat_tmp$f_age>=18&wagedat_tmp$f_age<=65)|is.na(wagedat_tmp$f_age)==1,]

#Sample restriction: state is reported
wagedat_tmp <- wagedat_tmp[is.na(wagedat_tmp$state)==0,]


#Trim top/bottom 1% of wages by year

# Compute wage quantiles
q_m <- do.call("rbind",
        tapply(wagedat_tmp$m_wage,       
               wagedat_tmp$year,           
               quantile, probs = c(1, 99)/100, na.rm = TRUE))
q_f <- do.call("rbind",
        tapply(wagedat_tmp$f_wage,      
               wagedat_tmp$year,         
               quantile, probs = c(1, 99)/100, na.rm = TRUE))
summary(wagedat_tmp$m_wage)
summary(wagedat_tmp$f_wage)

years <- c(seq(1985,2002))
for (i in 1:length(years)) {
 wagedat_tmp <- wagedat_tmp %>% mutate(m_wage = ifelse((m_wage<q_m[i,1]|m_wage>q_m[i,2])&year==years[i],NA_real_,m_wage),
                                    f_wage = ifelse((f_wage<q_f[i,1]|f_wage>q_f[i,2])&year==years[i],NA_real_,f_wage)) 
}

summary(wagedat_tmp$m_wage)
summary(wagedat_tmp$f_wage)

# Calculate log wage measures and log relative wage for trimmed wages
wagedat_tmp <- wagedat_tmp %>% mutate(
                                        ln_wage_m=log(m_wage),
                                        ln_wage_f=log(f_wage),
                                        ln_wage_fm_ratio = ln_wage_f - ln_wage_m)        
                                  

# Create positive wages and hours indicators
wagedat_tmp <- wagedat_tmp %>% mutate(#childcare expenditures from CDS
                                        #wage, earnings, and hours by mother and father
                                        pos_wage_m = ifelse(m_wage>0 & !is.na(m_wage), 1,0),
                                        pos_wage_m = ifelse(is.na(m_wage), NA,pos_wage_m),
                                        pos_wage_f = ifelse(f_wage>0 & !is.na(f_wage), 1,0),
                                        pos_wage_f =ifelse(is.na(f_wage), NA,pos_wage_f),
                                        
                                        pos_earn_m = ifelse(m_earn>0 & !is.na(m_earn), 1,0),
                                        pos_earn_m = ifelse(is.na(m_earn), NA,pos_earn_m),
                                        pos_earn_f = ifelse(f_earn>0 & !is.na(f_earn), 1,0),
                                        pos_earn_f = ifelse(is.na(f_earn), NA,pos_earn_f),     
                                        
                                        pos_hrs_m = ifelse(m_hrs>0 & !is.na(m_hrs), 1,0),
                                        pos_hrs_m= ifelse(is.na(m_hrs), NA,pos_hrs_m),
                                        pos_hrs_f = ifelse(f_hrs>0 & !is.na(f_hrs), 1,0),
                                        pos_hrs_f=ifelse(is.na(f_hrs), NA,pos_hrs_f),
                                        #replace wage and earnings to missing if hours are missing
                                        pos_wage_m= ifelse(is.na(m_hrs), NA,pos_wage_m),
                                        pos_wage_f= ifelse(is.na(f_hrs), NA,pos_wage_f),
                                        pos_earn_m= ifelse(is.na(m_hrs), NA,pos_earn_m),
                                        pos_earn_f= ifelse(is.na(f_hrs), NA,pos_earn_f),
                                        pos_hrs_mf =pos_hrs_m*pos_hrs_f)



#saving the dataset to dta format
write.dta(wagedat_tmp, "~/Desktop/PSID_CDS/PSID_CLEAN/wagedat_tmp_R.dta")

```


#Data cleaning in child's panel for the analysis in STATA
The code below does some basic data cleaning to child's panel.

```{r}

sample_child <- read.csv("~/Dropbox/PSID_CDS/PSID_CLEAN/ChildPanelCDS.csv")  %>% mutate(
                              age_oldest = replace(age_oldest, which(num_child==0), NA),
                              age_youngest = replace(age_youngest, which(num_child==0), NA),
                              m_earn = replace(m_earn, which(m_earn<0), NA),
                              f_earn = replace(f_earn, which(f_earn<0), NA),
                              m_wage = replace(m_wage, which(m_wage<0), NA),
                              f_wage = replace(f_wage, which(f_wage<0), NA),
                              house_earn = replace(house_earn, which(house_earn<0), NA))


# replace TRUE/FALSE in marital status and ever married to an indicator variable
sample_child$mar_stat [sample_child$mar_stat == "TRUE"] <- 1
sample_child$mar_stat [sample_child$mar_stat == "FALSE"] <- 0
sample_child$ever_married [sample_child$ever_married == "TRUE"] <- 1
sample_child$ever_married [sample_child$ever_married == "FALSE"] <- 0

#generate race indicators
sample_child <- sample_child %>% mutate(
                                m_white= ifelse(Race==1,1,0), 
                                m_black=ifelse(Race==2,1,0), 
                                m_r_oth=ifelse(Race>2,1,0))



#renaming some of the variables used in the analysis: 1) indicator variable for being currently married 2) age of mother 3) state fips code to 'state' for merging 4) annual childcare expenditures from main PSID survey 5) mother's standardized cognitive score

sample_child <- sample_child %>% rename( curr_married=mar_stat, m_age=age_mother, state_psid=state, state=StFIPS, chcare_ann=childcare_exp, m_pc97=m_pc_st)

# generate a measure for weekly childcare expenditure based on the annual childcare expenditure report from main PSID
sample_child <- sample_child %>%  mutate(chcare_hh = chcare_ann/52)



#create indicator variables for parental educational categories: 
#hsd - high-school dropout; hs - high schoold graduate; scoll - some college; coll - college; postcoll - postgraduate; collplus - undergraduate and postgraduate degrees
#fathers educational categories
sample_child <- sample_child %>%mutate(
                              fed_hsd= ifelse(sample_child$f_ed== "<12",1,0),
                              fed_hs= ifelse(sample_child$f_ed== "12",1,0),
                              fed_scoll= ifelse(sample_child$f_ed== "13-15",1,0),
                              fed_coll= ifelse(sample_child$f_ed== "16",1,0),
                              fed_postcol= ifelse(sample_child$f_ed== ">16",1,0),
                              fed_collplus = fed_coll+fed_postcol)


table(sample_child$f_ed, useNA = "always")
table(sample_child$fed_hsd, useNA = "always")


#mothers educational categories
sample_child <- sample_child %>%mutate(
                                med_hsd= ifelse(sample_child$m_ed== "<12",1,0),
                                med_hs= ifelse(sample_child$m_ed== "12",1,0), 
                                med_scoll= ifelse(sample_child$m_ed== "13-15",1,0),
                                med_coll= ifelse(sample_child$m_ed== "16",1,0),
                                med_postcol= ifelse(sample_child$m_ed== ">16",1,0),
                                med_collplus = med_coll+med_postcol)

table(sample_child$m_ed, useNA = "always")
table(sample_child$med_hsd, useNA = "always")


# create a variable: mother's age at birth, age at birth of the oldest child, number of children younger than 12 
sample_child <- sample_child %>% mutate(momageatbirth = m_age - age,
                                        num_0_12=num_0_5+num_6_12,
                                        #mom age at oldest child's birth
                                        momageatbirth1 = m_age - age_oldest)


# create variables describing age composition of children

sample_child <- sample_child %>% mutate(
                                        age_gap= age_oldest-age_youngest,
                                        age_rel_to_y = age-age_youngest,
                                        age_rel_to_o = age-age_oldest,
                                        age0to5only= ifelse(age_oldest<=5,1,0),  
                                        age5to10only= ifelse(age_oldest<=10&age_youngest>=5,1,0),
                                        age0to10only= ifelse(age_oldest<=10,1,0),
                                        age0to12only= ifelse(age_oldest<=12,1,0),
                                        age5to12only= ifelse(age_oldest<=12&age_youngest>=5,1,0),
                                        age6to12only= ifelse(age_oldest<=12&age_youngest>=6,1,0),
                                        very_young= ifelse(age<=2,1,0))


names(sample_child)<- tolower(names(sample_child))

#Generate total household expenditures on goods measure and expanded investment and social time measure. 
 sample_child <- sample_child %>%  
   rename(p_chcare=price)  %>%  
   mutate(hhinvest = schsupplies+toys+sports+lessons+tutoring+comm_grps, 
                   hhinvest_vc = hhinvest + vacation + clothing, 
                   hhexp_vcf=hhinvest_vc + food)
# %>% mutate(tau_m_socinvest=tau_m_ex_inv+tau_m_ex_soc,tau_f_socinvest=tau_f_ex_inv+tau_f_ex_soc)


write.dta(sample_child, "~/Desktop/PSID_CDS/PSID_CLEAN/CDSMainPanel_R.dta")

```

Merge additional information on wages from CPS and childcare prices; keep only households with children in 1997 and 2002.

```{r}

# Generate an indicator for some non-missing CDS investment measure
sample_child$CDS_invest_ind = with(sample_child, ifelse(is.na(tau_m)&is.na(tau_f)&is.na(chcare)& is.na(hhinvest), 0,1))
 
#Sample restriction:keep only children aged 0-18, HH with children
sample_child <- sample_child[sample_child$age>=0&sample_child$age<=18&sample_child$num_child>0,]



# import state-year average wage measures constructed from CPS "wages_cps.dta" from dta to csv and merge with the child's panel
library(haven)
wages_cps <- read_dta("~/Desktop/PSID_CDS/PSID_CLEAN/wages_cps.dta")
psid_child <- sample_child %>%left_join(wages_cps)

#Import state-year childcare price data from dta to csv and merge with the child's panel
p_extendedcosts <- read_dta("~/Desktop/PSID_CDS/PSID_CLEAN/p_extendedcosts.dta")%>%rename(state = stateid, p_all=all, p_goods=goods, p_serv=servo)
psid_child <- psid_child %>%left_join(p_extendedcosts)
#Import region and district dummies and merge with child data
crosswalk_state_reg_div <- read_dta("~/Desktop/PSID_CDS/PSID_CLEAN/crosswalk_state_reg_div.dta")%>%rename(region_name=region, division_name=division, state_name=state, state=fipcode, region=regioncode, division=divisioncode )
psid_child <- psid_child %>%left_join(crosswalk_state_reg_div)




 #Sample restriction:keep only 1997 and 2007 due to the availability of investment information
psid_child <- psid_child[psid_child$year==1997|psid_child$year==2002,]
psid_child <- psid_child[is.na(psid_child$year)==0,]

write.dta(psid_child, "~/Desktop/PSID_CDS/PSID_CLEAN/psid_child_R.dta")




```
#Sample selection in child's panel for the analysis in STATA
The code below introduces sample restrictions to be used in the relative demand for inputs estimation and calculates the relative inputs and relative input prices ratios.

Restrictions:
- Parents ages 18-65 during survey year
- Mothers were ages 16-45 during year of childâ€™s birth
- Child-year observations for children ages 12 and under
- Child-year observations for households with only 1 or 2 children ages 12 of younger (can have older children)

Additional data cleaning (set reported variables to missing):
- Top and bottom 1% of wages for fathers and mothers within every year between 1985-2002.
- Reports on weekly time investment lower than 0.25 or higher than 100 weekly hours.
- Reports on weekly childcare expenditures lower than 1 or higher than 1000 dollars.
- Reports on weekly household expenditures below 1 dollar.



```{r}


# Introduce sample selection rules for the child sample psid_child.dta

#Sample restriction:restrict to sample mothers ages 16-45 when child was born
psid_child <-psid_child[(psid_child$momageatbirth>=16&psid_child$momageatbirth<=45)|is.na(psid_child$momageatbirth),]

#Sample restriction:restrict to working age parents
psid_child <- psid_child[(psid_child$m_age>=18&psid_child$m_age<=65)|is.na(psid_child$m_age),]
psid_child <- psid_child[(psid_child$f_age>=18&psid_child$f_age<=65)|is.na(psid_child$f_age),]

#Sample restriction:restrict to those with some measure of investment in CDS_invest_ind
psid_child <- psid_child[psid_child$CDS_invest_ind==1,]



#Trim top/bottom 1% of wages by year
# Quantiles
q_m <- do.call("rbind",
        tapply(psid_child$m_wage,       # Specify numeric column
               psid_child$year,            # Specify group variable
               quantile, probs = c(1, 99)/100, na.rm = TRUE))
q_f <- do.call("rbind",
        tapply(psid_child$f_wage,       # Specify numeric column
               psid_child$year,            # Specify group variable
               quantile, probs = c(1, 99)/100, na.rm = TRUE))
summary(psid_child$m_wage)
summary(psid_child$f_wage)

# Samples between quantiles
psid_child <- psid_child %>% mutate(m_wage = ifelse((m_wage<q_m[1,1]|m_wage>q_m[1,2])&year==1997,NA,m_wage),
                                    m_wage = ifelse((m_wage<q_m[2,1]|m_wage>q_m[2,2])&year==2002,NA,m_wage),
                                    f_wage = ifelse((f_wage<q_f[1,1]|f_wage>q_f[1,2])&year==1997,NA,f_wage),
                                    f_wage = ifelse((f_wage<q_f[2,1]|f_wage>q_f[2,2])&year==2002,NA,f_wage)             
                                    )

#Calculate log wages, and relative log wages between mother and father for trimmed wages
psid_child <- psid_child %>% mutate(
                                 ln_wage_m  = log(m_wage),  
                                 ln_wage_f = log(f_wage),
                                 ln_wage_fm_ratio = ln_wage_f - ln_wage_m)





#Create a weighted average HH investment price measure
psid_child <- psid_child %>%  mutate(p_avg = 0.3*p_serv + .7*p_goods)


# Create positive investment input and wages indicators

psid_child <- psid_child %>% mutate(#childcare expenditures from CDS
                                        pos_chcare = ifelse(chcare>0 & !is.na(chcare), 1,0),
                                        pos_chcare = ifelse(is.na(chcare), NA,pos_chcare),
                                        #annual childcare expenditures from main PSID
                                        pos_chcare_hh = ifelse(chcare_hh>0 & !is.na(chcare_hh), 1,0),
                                        pos_chcare_hh = ifelse(is.na(chcare_hh), NA,pos_chcare_hh),
                                        #household goods expenditures
                                        pos_hhinvest = ifelse(hhinvest>0 & !is.na(hhinvest), 1,0),
                                        pos_hhinvest = ifelse(is.na(hhinvest), NA,pos_hhinvest),
                                        # total time by mother and father
                                        pos_tau_m = ifelse(tau_m>0 & !is.na(tau_m), 1,0),
                                        pos_tau_m = ifelse(is.na(tau_m), NA,pos_tau_m),
                                        pos_tau_f = ifelse(tau_f>0 & !is.na(tau_f), 1,0),
                                        pos_tau_f = ifelse(is.na(tau_f), NA,pos_tau_f),
                                        #wage, earnings, and hours by mother and father
                                        pos_wage_m = ifelse(m_wage>0 & !is.na(m_wage), 1,0),
                                        pos_wage_m = ifelse(is.na(m_wage), NA,pos_wage_m),
                                        pos_wage_f = ifelse(f_wage>0 & !is.na(f_wage), 1,0),
                                        pos_wage_f =ifelse(is.na(f_wage), NA,pos_wage_f),
                                        
                                        pos_earn_m = ifelse(m_earn>0 & !is.na(m_earn), 1,0),
                                        pos_earn_m = ifelse(is.na(m_earn), NA,pos_earn_m),
                                        pos_earn_f = ifelse(f_earn>0 & !is.na(f_earn), 1,0),
                                        pos_earn_f = ifelse(is.na(f_earn), NA,pos_earn_f),     
                                        
                                        pos_hrs_m = ifelse(m_hrs>0 & !is.na(m_hrs), 1,0),
                                        pos_hrs_m= ifelse(is.na(m_hrs), NA,pos_hrs_m),
                                        pos_hrs_f = ifelse(f_hrs>0 & !is.na(f_hrs), 1,0),
                                        pos_hrs_f=ifelse(is.na(f_hrs), NA,pos_hrs_f),
                                        #replace wage and earnings to missing if hours are missing
                                        pos_wage_m= ifelse(is.na(m_hrs), NA,pos_wage_m),
                                        pos_wage_f= ifelse(is.na(f_hrs), NA,pos_wage_f),
                                        pos_earn_m= ifelse(is.na(m_hrs), NA,pos_earn_m),
                                        pos_earn_f= ifelse(is.na(f_hrs), NA,pos_earn_f),
                                        pos_hrs_mf =pos_hrs_m*pos_hrs_f)

#calculate childcare expenditure per child based on main PSID report and use it to impute childcare expenditures when they are not reported in CDS

psid_child <- psid_child %>% mutate(
                                  #weekly measure of HH expenditures on childcare per kid ages 0-12 (avail 2002) 
                                 chcare_hh_pc = chcare_hh/num_0_12, 
                                 chcare_imp = ifelse(is.na(chcare),chcare_hh_pc, chcare),
                                 #indicator for positive reports
                                 pos_chcare_imp = ifelse(chcare_imp>0 & !is.na(chcare_imp), 1,0),
                                 pos_chcare_imp = ifelse(is.na(chcare_imp), NA,pos_chcare_imp))



#Generate log input measures, keep log investment:
#time - if between 0.25 and 100 weekly hours
#HH expenditures on goods - higher than $1 per week
#measures of childcare expenditures- between $1 and $1000 dollars per week
psid_child <- psid_child %>% mutate(
                                 ln_tau_m = log(tau_m),  
                                 ln_tau_f = log(tau_f),
                                 ln_hhinvest = log(hhinvest),
                                 ln_chcare = log(chcare),
                                 ln_chcare_hh_pc=log(chcare_hh_pc),
                                 
                                 ln_tau_m=ifelse(tau_m<0.25|tau_m>100, NA, ln_tau_m),
                                 ln_tau_f=ifelse(tau_f<0.25|tau_f>100, NA, ln_tau_f),
                                 ln_hhinvest=ifelse(hhinvest<1, NA, ln_hhinvest),
                                 ln_chcare=ifelse(chcare<1|chcare>1000, NA,ln_chcare),
                                 ln_chcare_hh_pc=ifelse(chcare_hh_pc<1|chcare_hh_pc>1000, NA,ln_chcare_hh_pc),
                                 ln_chcare_imp = ifelse(is.na(ln_chcare),ln_chcare_hh_pc, ln_chcare)
                                 )







# Calculate investments, investment expenditures 
psid_child <- psid_child %>% mutate(
                                  #joint time with father and mother for two-parent HH
                                 tau_mf= case_when(curr_married==1~tau_m+tau_f,TRUE~tau_m ), 
                                 #time expenditure for mother and father, joint
                                 tau_m_exp=m_wage*tau_m,
                                 tau_f_exp=f_wage*tau_f,
                                 tau_mf_exp= case_when(curr_married==1~tau_m_exp+tau_f_exp,TRUE~tau_m_exp))





#Create log relative input price ratios (scale childcare costs from annual into hourly units assuming average full-time care is 33hrs/week x 52 weeks))
psid_child <- psid_child %>% mutate(
                                 ln_pratio_4ca = log(p_yocent_e_cps_cpkt) - log(p_avg) - log(33*52),
                                 ln_pratio_ica = log(p_icent_e_cps_cpkt)  - log(p_avg) - log(33*52),
                                 ln_pratio_4fa = log(p_yofcc_e_cps_cpkt)  - log(p_avg)  - log(33*52),
                                 ln_pratio_ifa = log(p_ifcc_e_cps_cpkt)   - log(p_avg) - log(33*52),
                                 ln_wage_m_rel = ln_wage_m - log(p_avg),
                                 ln_wage_f_rel = ln_wage_f - log(p_avg),
                                 ln_P4ca_Wm_ratio = log(p_yocent_e_cps_cpkt) - ln_wage_m - log(33*52),
                                 ln_Pica_Wm_ratio = log(p_icent_e_cps_cpkt)  - ln_wage_m - log(33*52),
                                 ln_P4fa_Wm_ratio = log(p_yofcc_e_cps_cpkt)  - ln_wage_m - log(33*52),
                                 ln_Pifa_Wm_ratio = log(p_ifcc_e_cps_cpkt)   - ln_wage_m - log(33*52),
                                 ln_P4ca_Wf_ratio = log(p_yocent_e_cps_cpkt) - ln_wage_f - log(33*52),
                                 ln_Pica_Wf_ratio = log(p_icent_e_cps_cpkt)  - ln_wage_f - log(33*52),
                                 ln_P4fa_Wf_ratio = log(p_yofcc_e_cps_cpkt)  - ln_wage_f - log(33*52),
                                 ln_Pifa_Wf_ratio = log(p_ifcc_e_cps_cpkt)   - ln_wage_f - log(33*52))
                          

 #create log input and input expenditure ratios   
psid_child <- psid_child %>% mutate(
                               #ln(tau_f/tau_m)
                               ln_tau_fm_ratio = ln_tau_f - ln_tau_m ,
                               #ln(W_f tau_f/ (W_m tau_m))
                               ln_tau_fm_exp_ratio = ln_tau_f + ln_wage_f - ln_tau_m - ln_wage_m ,
                               #mother ln(tau/g)
                               ln_tau_m_g_ratio = ln_tau_m - ln_hhinvest + log(p_avg) ,
                               #father ln(tau/g)
                               ln_tau_f_g_ratio = ln_tau_f - ln_hhinvest + log(p_avg) ,
                               #mother ln(W*tau/(p*g))
                               ln_tau_m_g_exp_ratio = ln_tau_m + ln_wage_m  - ln_hhinvest  , 
                               #father ln(W*tau/(p*g))
                               ln_tau_f_g_exp_ratio = ln_tau_f + ln_wage_f - ln_hhinvest ,
                               #ln(PY/(p*g)) -- child-specific measure
                               ln_invratio       = ln_chcare - ln_hhinvest ,
                               #ln(PY/(p*g)) -- per capita HH measure
                               ln_invratio_hh_pc = ln_chcare_hh_pc - ln_hhinvest,
                               #ln(PY/(p*g)) -- imputed measure from child-specific & per capita HH measures
                               ln_invratio_imp   = ln_chcare_imp - ln_hhinvest,   
                               #mother ln(Y*P/W*tau)
                               ln_YP_tauW_m  = ln_chcare_imp - (ln_tau_m + ln_wage_m),
                               #father ln(Y*P/W*tau)
                               ln_YP_tauW_f  = ln_chcare_imp - (ln_tau_f + ln_wage_f)  
                             )
 
 #Create person-specific measures of avg wages from CPS (to be used as instruments)

 # difference in male-fem avg log wages by state-year & educ for ages 30-39  (matches with father/mother)
 psid_child <- psid_child %>% mutate(
                               Dln_avgwage_hs_30    = lnhwage_m_hs_30 - lnhwage_f_hs_30,            # HS grads
                               Dln_avgwage_scoll_30 = lnhwage_m_scoll_30 - lnhwage_f_scoll_30,      # some coll
                               Dln_avgwage_coll_30  = lnhwage_m_coll_30 - lnhwage_f_coll_30,        # coll grads
                                
                              #make mother/father education-specific predicted wages (uses HS wages for HS dropouts and grads) based on age 
                              # note m refers to mother in psid but the m refers to male for avg wages in CPS
                              
                               m_ln_avgwage_30 = case_when((med_hsd==1|med_hs==1) ~ lnhwage_f_hs_30, med_scoll==1 ~ lnhwage_f_scoll_30 , med_collplus==1~ lnhwage_f_coll_30, TRUE~NA_real_),  
                              
                               f_ln_avgwage_30 = case_when((fed_hsd==1|fed_hs==1) ~ lnhwage_m_hs_30, fed_scoll==1 ~ lnhwage_m_scoll_30 , fed_collplus==1~ lnhwage_m_coll_30, TRUE~NA_real_), 
                              # rescale mother- or father-specific measures by average HH investment input prices
                              
                                m_ln_avgwage_30 = m_ln_avgwage_30 - log(p_avg),
                                f_ln_avgwage_30 = f_ln_avgwage_30 - log(p_avg),
                              #make education-specific avg father/mother predicted log wage ratio by age (use HS wages for HS dropouts and grads)
                              
                               Dln_avgwage_30 = f_ln_avgwage_30 - m_ln_avgwage_30
                              )


 # difference in male-fem avg log wages by state-year & educ for ages 40-49  (matches with father/mother)
 psid_child <- psid_child %>% mutate(
                               Dln_avgwage_hs_40    = lnhwage_m_hs_40 - lnhwage_f_hs_40,            # HS grads
                               Dln_avgwage_scoll_40 = lnhwage_m_scoll_40 - lnhwage_f_scoll_40,      # some coll
                               Dln_avgwage_coll_40  = lnhwage_m_coll_40 - lnhwage_f_coll_40,        # coll grads
                                
                              #make mother/father education-specific predicted wages (uses HS wages for HS dropouts and grads) based on age 
                              # note m refers to mother in psid but the m refers to male for avg wages in CPS
                              
                               m_ln_avgwage_40 = case_when((med_hsd==1|med_hs==1) ~ lnhwage_f_hs_40, med_scoll==1 ~ lnhwage_f_scoll_40 , med_collplus==1~ lnhwage_f_coll_40, TRUE~NA_real_),         
                              
                               f_ln_avgwage_40 = case_when((fed_hsd==1|fed_hs==1) ~ lnhwage_m_hs_40, fed_scoll==1 ~ lnhwage_m_scoll_40 , fed_collplus==1~ lnhwage_m_coll_40, TRUE~NA_real_),                    
                              # rescale mother- or father-specific measures by average HH investment input prices
                              
                                m_ln_avgwage_40 = m_ln_avgwage_40 - log(p_avg),
                               f_ln_avgwage_40 = f_ln_avgwage_40 - log(p_avg),
                              #make education-specific avg father/mother predicted log wage ratio by age (use HS wages for HS dropouts and grads)
                              
                               Dln_avgwage_40 = f_ln_avgwage_40 - m_ln_avgwage_40
                              )
 
 
#make age- and education-specific avg. father/mother predicted log wage ratio (use HS wages for HS dropouts and grads)
#note that the components f_ln_avgwage_* have already been scaled by average HH investment input prices (do not need to rescale again!)

 psid_child <- psid_child %>% mutate(
                       f_ln_avgwage=case_when(f_age>=40 ~ f_ln_avgwage_40, f_age<40 ~ f_ln_avgwage_30, TRUE~NA_real_),
                       m_ln_avgwage=case_when(m_age>=40 ~ m_ln_avgwage_40, m_age<40 ~ m_ln_avgwage_30, TRUE~NA_real_),
                       Dln_avgwage = f_ln_avgwage - m_ln_avgwage)
 
summary(psid_child$m_wage)
summary(psid_child$f_wage)

write.dta(psid_child, "~/Desktop/PSID_CDS/PSID_CLEAN/psid_fam_R.dta")


#Sample restriction: keep only families with children <=12
psid_child <- psid_child[psid_child$age<=12,]

write.dta(psid_child, "~/Desktop/PSID_CDS/PSID_CLEAN/psid_fam_young_R.dta")


```

