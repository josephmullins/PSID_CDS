---
title: "Creating a Panel Dataset for Caucutt et al."
output: html_notebook
---

# Creating a Panel Dataset
This script uses the cleaned PSID and CDS data to construct a panel of observations built around mothers in the PSID, wherein we apply a number of sample restrictions.

## Fertility History Panel

We start by loading the childbirth history file, which we will use to identify mothers and arrange their fertility history into a panel dataset. It will be useful to know the following mapping between variable names and variables:

Vnum     Vname
-------  ----------------------
CAH3     intnum68
CAH4     pernum
CAH5     sex
CAH6     parent month of birth
CAH7     parent year of birth
CAH8     marital status when born
CAH9     birth order
CAH10    child intnum
CAH11    child pernum
CAH12    sex of child
CAH13    child month of birth
CAH15    child year of birth
CAH108   number of birth records

The chunk below loads these data and applies some sample restrictions:
 - Drop women without recorded births
 - Drop women with missing birth year information
 - Drop women with missing information in their childbirth history
 - Keep only women whose children appear in the CDS

First, we use one of the cleaned CDS files to identify the children in the CDS.

```{r}
KID <- read.csv("../../data-cds/assessments/AssessmentPanel.csv") %>%
  select(KID) %>%
  unique()

```

Next, we link them with their mothers using the childbirth and adoption history file, and apply the above sample restrictions.

```{r}

C = read.csv("../../data-main/childbirth/Childbirth.csv") %>% 
  mutate(X = NULL) %>% #<- load childbirth file
  filter(CAH5==2)  %>% #keep only women
  filter(CAH10!=0) %>% # drop women who have no children according to this file
  filter(CAH7!=9998) %>% # drop women with missing birth year info
  mutate(MID = CAH3*1000 + CAH4, KID = CAH10*1000 + CAH11) %>% #<- create identifier for mother and child
  select(KID) %>%
  unique() %>%
  inner_join(KID) #%>% #<- keep only women whose children are in the CDS
  group_by(MID) %>%
  filter(!any(CAH10 == 9999))

#Link mother's standardized and raw passage comprehension scores from the 1997 PCG interview to mother's. 

m_pc97 <- read.csv("~/Dropbox/PSID_CDS/PSID_RAW/MotherPC.csv") %>% 
  mutate(KID = ER30001*1000 + ER30002) %>% 
  select(KID,Q1PCSS,Q1PCRAW,PCG)%>%
  rename(m_pc_st= Q1PCSS, m_pc_raw= Q1PCRAW)

#Replace missing values to NA and keep only scores reported by mothers of the child
var <- c("m_pc_st", "m_pc_raw")
missing <- c(0, 99)
for (i in 1:2) {
  m_pc97[,var[i]] = na_if(m_pc97[,var[i]],missing[i])
  m_pc97[,var[i]] = ifelse(m_pc97$PCG==1,m_pc97[,var[i]],NA)
}
m_pc97<-m_pc97 %>% select(KID,m_pc_st,m_pc_raw)
write.csv(m_pc97,"~/Dropbox/PSID_CDS/PSID_CLEAN/AssessmentMother.csv")

# Merge mother's score with mother's panel
m_pc97 <- merge(x=C,y=m_pc97,by="KID",all=TRUE)%>% group_by(MID) %>%
select(MID,m_pc_st,m_pc_raw) %>% drop_na(m_pc_st,m_pc_raw) %>%distinct(MID, .keep_all= TRUE)


```
 
We want a panel dataset that begins when each mother turns 18 and ends in 2017. Each individual-year observation has the number of dependent children, the age of the youngest child, the number of children between 0 and 5, and the number of children between 6 and 12.

The function below does this assuming that the dataframe $d$ contains the childbirth data for just one mother:

```{r}
MakePanel <- function(d) {
  year <- (d$CAH7[1]+18):2017
  Ny <- length(year)
  knum = d$CAH108[1]
  age_youngest <- integer(Ny) -1
  age_oldest <- integer(Ny) + Inf
  num_0_5 <- integer(Ny)
  num_6_12 <- integer(Ny)
  num_child <- integer(Ny)
  age_mother = year-d$CAH7[1]
  for (i in 1:length(year)) {
    ay = Inf
    ao = -1
    a5 = 0
    a6 = 0
    for (k in 1:nrow(d)) {
      agek = year[i]-d$CAH15[k]
      if (agek>=0 & agek<=18) {
        #print(agek)
        ay = min(ay,agek)
        ao = max(ao,agek)
        num_child[i]  = num_child[i] + 1
      }
      if (agek>=0 & agek<=5) {
        a5 = a5 + 1
      }
      if (agek>5 & agek<=12) {
        a6 = a6 + 1
      }

    }
    age_youngest[i] = ay
    age_oldest[i] = ao
    num_0_5[i] = a5
    num_6_12[i] = a6
  }
  data.frame(MID = d$MID[1], age_mother=age_mother, year = year, knum = knum, num_child=num_child,age_youngest=age_youngest,age_oldest=age_oldest, num_0_5 = num_0_5, num_6_12 = num_6_12, y_first = d$CAH15[1])
}

```

The chunk below applies the function for each mother (defined by their ID number *MID*) which results in a panel dataset. In order to speed up analysis, we also drop observations that we know will be too early for the CDS (everyone with first births before 1960).

```{r}

D <- C %>% group_by(MID) %>% do(MakePanel(.)) %>% filter(y_first>=1960) %>%
left_join(m_pc97) # Add mother's cognitive score
```

## Merge in State Identifiers and Childcare Expenditures

We start by merging this panel with the Individual Cross-Year File, which maps an (ID,year) combination with an interview number and sequence number (which allows us to link with state codes and household child care expenditures)

This chunk loads the individual file and creates the ID number:
```{r}
Ind = read.csv("~/Dropbox/PSID_CDS/PSID_RAW/IndFileVertical.csv") %>% 
  mutate(X = NULL) %>% 
  mutate(MID = intnum68*1000 + pernum,mar_stat = mpair>0)

```

Since we would like to see marital status in some non-interview years, we use the following year's marital status:

```{r}
Ind <- Ind %>% filter(year>=1999) %>% 
  mutate(year = year - 1) %>%
  rbind(Ind)
```
This method of imputation ensures that we only fill in missing data from non-interview years.

One thing that will be useful throughout is a panel with the mother's ID linked to their interview and calendar year. Some variables from the main interview refer to the previous year and things can get messy, so we use this file to keep things consistent.
```{r}
# this will be useful throughout: create a dataframe that maps mothers to their interview number and sequence number
D_Ind <- D %>%
  inner_join(Ind)
```

Next we load in a panel of state codes, which we merge with the cross-year individual file. We then merge that file with a state code cross-walk so that we can link the PSID's state code with FIPS and SOI. We also merge, based on the household interview number and year, annual household expenditures on child care (cleaned in a previous section).

Finally, this file is merged with the panel of mothers we just created, using years before and after to fill in missing state observations.

```{r}
# state codes measures residence for survey year
state_codes = read.csv("~/Dropbox/PSID_CDS/StateCodes.csv") %>% mutate(X=NULL,X.1 = NULL) %>% #<- this is a simple crosswalk of state codes
  select(-state) %>% 
  rename(state = PSID, StFIPS = fips) %>% #<- we rename some things in order to do the merge properly
  select(state,StFIPS,SOI)


# child care expenditures are for previous year, so we have to be careful how we do the merge!
# we merge by survey year then subtract one year to make the reference correct
# then we drop intnum, using only MID and year to link with the main file in the next step
ch_care <- read.csv("~/Dropbox/PSID_CDS/PSID_CLEAN/Main_childcare.csv") %>% 
  mutate(X=NULL) %>%
  inner_join(D_Ind) %>% #<- merge to mother's through the panel file
  mutate(year = year-1) %>% #<- convert survey year to lag year
  select(MID,year,childcare_exp)


D <- read.csv("~/Dropbox/PSID_CDS/PSID_RAW/StateVertical.csv") %>% #<- state of residence panel data
  mutate(X=NULL) %>%
  right_join(Ind) %>% #<- merge with Individual file
  right_join(D) %>% #<- merge with the panel we created (keeping all years)
  arrange(MID,year) %>%
  group_by(MID) %>%
  fill(state,.direction = "downup") %>% #<- fill in missing observations
  merge(state_codes) %>% #<- merge in the cross-walk with FIPS codes and SOI codes
  left_join(ch_care) #<= use only the main file to link
```

## Identify and Merge in Spouses ("Fathers")

The next step is to identify spouses for each mother in each year. Spouses are linked by the *mpair* variable which is unique within a household interview. We identify partners by:
1. Merging the individual file with the triple (*MID*,*year*,*age_mother*) from the panel, keeping all observations from the individual file.
2. Partners are identified by the fact that they are not successfully matched in this merge, meaning that *age_mother* will be missing. We keep those observations and rename the variables in order to merge them once more with the panel of mothers.

```{r}
D <- D %>%
  select(MID,year,age_mother) %>%
  right_join(Ind) %>% #<- merge with individual file, keep all observations from Ind
  filter(is.na(age_mother)) %>% #<- identify spouses by missing info from the merge
  rename(FID=MID,snF=sn) %>% #<- rename variables for merge
  filter(mpair>0) %>% #<- only keep individuals who are not mothers but who are in a relationship in the same household
  select(FID,year,intnum,mpair,snF) %>%
  right_join(D) %>% #<- do the merge
  mutate(snF = replace_na(snF,-1)) #<- replace missing values.


```

## Merge in Spouse Birth Year and Marriage Summary Variables

The *Marriage History File* is prepared by the PSID and contains a record of each marriage in the PSID. We use this file to determine which individuals have ever been married, to filter out individuals with missing marriage information, and to identify the birth year of spouses.

First we load the marriage file and create an "ever" married summary variable. We finish by merging this file with the main panel (based on MID)

```{r}
# #  ---- load marriage info and create some summary variables
M <- read.csv("~/Dropbox/PSID_CDS/PSID_RAW/Marriage.csv") %>%
  mutate(X = NULL) %>%
  rename(MID = ID1) %>% #<- we rename to MID in preparation for a first merge with sample mothers
  rename(ybirth = MH6) %>%
  filter(ybirth<9998) %>% #<- drop individuals with missing birth info
  rename(ymar = MH11) %>%
  filter(ymar!=9998) %>% #<- remove individuals without marriage info
  mutate(record = ymar<9999) %>% #<- ymar==9999 indicates never married
  group_by(MID) %>%
  summarise(ever_married = sum(record)>0,ybirth = ybirth[1])

D = M %>% 
  inner_join(D)


```

We also use this file to merge with FID for each spouse to deduce the spouse's age. This means we don't have the spouse's age for cohabiting couples. We use the triple *year*, *intnum* and *mpair* to match women with their spouses. To do this, we first create an individual index file of people that are *not* women in the sample. This is the potential pool of fathers that we use for the merge.

```{r}

D <- D_Ind %>%
  select(MID,year,age_mother) %>%
  right_join(Ind) %>%
  filter(is.na(age_mother)) %>% #<- pick out individuals from the merge who were *not* matched
  rename(FID = MID,snF = sn) %>%
  select(c("FID","year","intnum","mpair","snF")) %>%
  filter(mpair>0) %>%
  right_join(D)

D <- M %>%
  rename(FID=MID,ybirthF = ybirth) %>%
  right_join(D) %>%
  mutate(f_age = year - ybirthF)

```


## Merge in Mother's Race, Education, and CPI (external)
In the current version we don't use CPI, but we'll put it in anyway. Race and education are previously cleaned summary variables stored non-locally. We drop mothers from the sample with missing information on education and race.

```{r}
R <- read.csv("~/Dropbox/PSID_CDS/PSID_RAW/RaceHorizontal.csv") %>% mutate(X = NULL) %>% 
  rename(MID = ID)

educ = read.csv("~/Dropbox/PSID_CDS/PSID_RAW/HGC.csv") %>% 
  mutate(X = NULL,ID = intnum68*1000 + pnum68) %>%
  mutate(ed=case_when(hgc>16 ~ 5,hgc == 16 ~ 4, hgc>=13 ~ 3, hgc>=12 ~ 2, hgc<12 ~ 1)) %>%
  select(ID,ed) %>%
  mutate(ed = factor(ed,levels = c(1,2,3,4,5),labels=c("<12","12","13-15","16",">16")))
    
cpi = read.csv("~/Dropbox/PSID_CDS/CPI-U.csv") %>% 
  rename(year = YEAR) %>%
  mutate(CPIU = CPIU/CPIU[53])
  
```

Then we merge them into the main file.
```{r}
D <- D %>% #<- drop if mother has missing race or education info
  inner_join(R) %>% 
  inner_join(educ,by = c("MID" = "ID")) %>%
  rename(m_ed = ed) %>%
  left_join(educ,by = c("FID" = "ID")) %>%
  rename(f_ed = ed) %>%
  inner_join(R) %>%
  inner_join(cpi)
```

## Clean and Prepare Labor Market Data

Labor market earnings and hours come from the main interview of the PSID, which collects information for the "husband", the "wife" and other family members. Individuals can be matched to these variables via their sequence number in the household (which we will do below). First, let's load a cleaned panel dataset of these household data. 

```{r}
L = read.csv("~/Dropbox/PSID_CDS/PSID_RAW/LaborFile.csv") %>% mutate(X = NULL) #<- contains the hours and earnings of the "head" and the "wife" which can be matched to individuals via sequence number

```

Next, we merge with the main panel and assign wages, earnings, and hours, based on the mother's and father's sequence number, which tells us if they are either the "husband" or "wife" in the household.

```{r}
L <- D %>%
  select(MID,FID,year,intnum,sn,snF) %>% 
  inner_join(L) %>% #<- merge based on year and interview number
  mutate(m_hrs = case_when(sn==1 ~ h_hrs,sn==2 ~ w_hrs),m_earn = case_when(sn==1 ~ h_earn,sn==2 ~ w_earn)) %>%
  mutate(f_hrs = case_when(snF==1 ~ h_hrs,snF==2 ~ w_hrs),f_earn = case_when(snF==1 ~ h_earn,snF==2 ~ w_earn)) %>%
  mutate(m_wage = m_earn/m_hrs,f_wage = f_earn/f_hrs) %>%
  select(MID,year,m_earn,m_hrs,m_wage,f_earn,f_hrs,f_wage) %>% #<- we don't keep FID because the coupling MID,FID is dynamic and may not match the pair (MID,FID) from the previous year when we merge these data back in
  mutate(year = year - 1) #<- these variable refer to the previous year so we subtract one 

```



```{r}
T2 <- read.csv("../../data-main/labor-market/T2clean.csv")

# we link first to mothers:
T2m <- D %>%
  select(MID) %>%
  unique() %>%
  inner_join(T2) %>% #<- first four lines pick out mothers in CDS sample
  rename(m_earn = earn,m_hrs = hrs) %>%
  mutate(m_wage = m_earn/m_hrs) %>%
  select(MID,year,m_earn,m_wage,m_hrs) #<- these are mothers so drop the FID variable

# and then to fathers
T2f <- D %>%
  select(FID) %>% 
  unique() %>%
  inner_join(T2) %>% #<-first four lines pick out "fathers" in sample (recall we are labelling all spouses as fathers)
  rename(f_earn = earn,f_hrs = hrs) %>%
  mutate(f_wage = f_earn/f_hrs) %>%
  select(FID,year,f_earn,f_wage,f_hrs) #<- these are fathers so drop the MID variable

# now we link the pair (MID,FID,year) first to mothers (MID,year) and then to fathers (MID,year), *then* we append all of this to the data from the main interview

```


## Merge in Labor Market Earnings, Hours, Wages


We finish by (1) linking each of these files to mothers and fathers in our panel sample; (2) Adding this to the data from the main interview; and (3) Merging with the panel dataset.

```{r}
D <- D %>%
  select(MID,FID,year) %>%
  inner_join(T2m) %>%
  left_join(T2f) %>%
  select(-FID) %>%
  rbind(L) %>% #<- add all of this to the original data frame with the interview year questions
  mutate(house_earn = case_when(!is.na(f_earn) ~ f_earn+m_earn,TRUE ~ m_earn),m_wage = na_if(na_if(m_wage,Inf),0),f_wage = na_if(na_if(f_wage,Inf),0)) %>%
  right_join(D) #%>%
```

We save the panel dataset.
```{r}
write.csv(D,"~/Dropbox/PSID_CDS/PSID_CLEAN/MotherPanelCDS.csv")
```


# Creating a Child Panel
It may be useful to link the above panel of data to our data on children. The chunk of code below arranges the CDS data into a combined panel and merges it with *MotherPanelCDS*. 

```{r}


cds <- read.csv("~/Dropbox/PSID_CDS/PSID_RAW/MotherIndex.csv") %>% mutate(X=NULL)

 
D_main <- C %>%
  group_by(KID) %>%
  filter(sum(CAH2==2)==0) %>% # drop children with adoption records
  rename(ybirth_child = CAH15) %>%
  mutate(ybirth_child = na_if(ybirth_child,9998)) %>%
  select(MID,KID,ybirth_child) %>%
  merge(D) %>%
  mutate(age = year - ybirth_child) %>%
  left_join(A) %>% #<- left_join assessments
  left_join(Expenditures) %>%
  left_join(ChildCarePanel) %>%
  left_join(TD_agg) %>%
  left_join(PPE)  %>%
  select(-starts_with("Q21"),-starts_with("ER"))
  

write.csv(D_main,"~/Dropbox/PSID_CDS/PSID_CLEAN/ChildPanelCDS.csv")
```